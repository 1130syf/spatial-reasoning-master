<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostureScan Pro - æ‘„åƒå¤´æ•…éšœæ’é™¤å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        #cameraTest {
            width: 640px;
            max-width: 100%;
            height: 480px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 20px auto;
            display: block;
            background: #f7fafc;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .solutions {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .solutions h4 {
            color: #2d3748;
            margin-top: 0;
        }
        .solutions ol {
            padding-left: 20px;
        }
        .solutions li {
            margin: 10px 0;
            line-height: 1.6;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        #results {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ PostureScan Pro æ‘„åƒå¤´è¯Šæ–­å·¥å…·</h1>

        <div class="section">
            <h3>æ­¥éª¤ 1: æµè§ˆå™¨æƒé™æ£€æŸ¥</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ£€æŸ¥å¹¶è¯·æ±‚æ‘„åƒå¤´æƒé™ï¼š</p>
            <button onclick="checkCameraPermission()">æ£€æŸ¥æ‘„åƒå¤´æƒé™</button>
            <button onclick="requestCameraPermission()">è¯·æ±‚æ‘„åƒå¤´æƒé™</button>
            <div id="permissionStatus"></div>
        </div>

        <div class="section">
            <h3>æ­¥éª¤ 2: æ‘„åƒå¤´è®¾å¤‡æ£€æµ‹</h3>
            <p>æ£€æµ‹å¯ç”¨çš„æ‘„åƒå¤´è®¾å¤‡ï¼š</p>
            <button onclick="enumerateDevices()">åˆ—å‡ºæ‘„åƒå¤´è®¾å¤‡</button>
            <div id="deviceList"></div>
        </div>

        <div class="section">
            <h3>æ­¥éª¤ 3: æ‘„åƒå¤´åŠŸèƒ½æµ‹è¯•</h3>
            <p>æµ‹è¯•æ‘„åƒå¤´æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š</p>
            <button onclick="startCameraTest()">å¼€å§‹æ‘„åƒå¤´æµ‹è¯•</button>
            <button onclick="stopCameraTest()">åœæ­¢æ‘„åƒå¤´æµ‹è¯•</button>
            <video id="cameraTest" autoplay muted></video>
            <div id="testStatus"></div>
        </div>

        <div class="section">
            <h3>æ­¥éª¤ 4: æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥</h3>
            <button onclick="checkBrowserCompatibility()">æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§</button>
            <div id="browserInfo"></div>
        </div>

        <div class="section">
            <h3>è¯Šæ–­ç»“æœ</h3>
            <div id="results"></div>
        </div>

        <div class="solutions">
            <h4>ğŸ”§ å¸¸è§è§£å†³æ–¹æ¡ˆï¼š</h4>
            <ol>
                <li><strong>æµè§ˆå™¨æƒé™é—®é¢˜ï¼š</strong> ç¡®ä¿åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»æ‘„åƒå¤´å›¾æ ‡ï¼Œé€‰æ‹©"å…è®¸"ä½¿ç”¨æ‘„åƒå¤´</li>
                <li><strong>HTTPSåè®®ï¼š</strong> ç¡®ä¿ä½¿ç”¨ https:// è®¿é—®åº”ç”¨ï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨ http://localhost ä¹Ÿå¯ä»¥</li>
                <li><strong>æµè§ˆå™¨å…¼å®¹æ€§ï¼š</strong> æ¨èä½¿ç”¨ Chromeã€Firefox æˆ– Edge æµè§ˆå™¨çš„æœ€æ–°ç‰ˆæœ¬</li>
                <li><strong>è®¾å¤‡å ç”¨ï¼š</strong> æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–åº”ç”¨æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´ï¼ˆå¦‚Zoomã€Skypeç­‰ï¼‰</li>
                <li><strong>é˜²ç«å¢™è®¾ç½®ï¼š</strong> ç¡®ä¿é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢æ‘„åƒå¤´è®¿é—®</li>
                <li><strong>ç¡¬ä»¶æ£€æŸ¥ï¼š</strong> ç¡®è®¤æ‘„åƒå¤´ç¡¬ä»¶æ­£å¸¸å·¥ä½œï¼Œè®¾å¤‡ç®¡ç†å™¨ä¸­æ— é”™è¯¯</li>
                <li><strong>éšç§è®¾ç½®ï¼š</strong> Windows/macOS éšç§è®¾ç½®ä¸­å…è®¸åº”ç”¨è®¿é—®æ‘„åƒå¤´</li>
            </ol>
        </div>

        <div class="solutions">
            <h4>ğŸ’» ä»£ç ä¿®å¤å»ºè®®ï¼š</h4>
            <p>å¦‚æœä»¥ä¸Šæ£€æŸ¥éƒ½æ­£å¸¸ï¼Œä½†PostureScan Proä¸­æ‘„åƒå¤´ä»é»‘å±ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹ä»£ç ä¿®æ”¹ï¼š</p>

            <h5>1. ä¿®æ”¹æ‘„åƒå¤´é…ç½®ï¼ˆåœ¨ExerciseAnalysisPage.jsä¸­ï¼‰ï¼š</h5>
            <div class="code-block">
const camera = new cam.Camera(webcamRef.current.video, {
  onFrame: async () => {
    if (webcamRef.current?.video && poseRef.current) {
      try {
        await poseRef.current.send({ image: webcamRef.current.video });
      } catch (error) {
        console.error('Pose detection error:', error);
      }
    }
  },
  width: 640,  // é™ä½åˆ†è¾¨ç‡
  height: 480,
  facingMode: 'user',  // æ˜ç¡®æŒ‡å®šå‰ç½®æ‘„åƒå¤´
});
            </div>

            <h5>2. æ·»åŠ æ‘„åƒå¤´çº¦æŸæ£€æŸ¥ï¼š</h5>
            <div class="code-block">
async function initCamera() {
  try {
    const constraints = {
      video: {
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: 'user',
        deviceId: selectedCameraId
      }
    };

    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    webcamRef.current.video.srcObject = stream;
    return true;
  } catch (error) {
    console.error('Camera initialization failed:', error);
    return false;
  }
}
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let diagnostics = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            diagnostics.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('results').textContent = diagnostics.join('\n');
        }

        async function checkCameraPermission() {
            try {
                const permission = await navigator.permissions.query({ name: 'camera' });
                const status = document.getElementById('permissionStatus');

                if (permission.state === 'granted') {
                    status.innerHTML = '<div class="success">âœ… æ‘„åƒå¤´æƒé™å·²æˆäºˆ</div>';
                    log('æ‘„åƒå¤´æƒé™å·²æˆäºˆ');
                } else if (permission.state === 'prompt') {
                    status.innerHTML = '<div class="warning">âš ï¸ éœ€è¦è¯·æ±‚æ‘„åƒå¤´æƒé™</div>';
                    log('éœ€è¦è¯·æ±‚æ‘„åƒå¤´æƒé™', 'warning');
                } else if (permission.state === 'denied') {
                    status.innerHTML = '<div class="error">âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»</div>';
                    log('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»', 'error');
                }

                permission.onchange = () => checkCameraPermission();
            } catch (error) {
                document.getElementById('permissionStatus').innerHTML =
                    '<div class="info">â„¹ï¸ è¯¥æµè§ˆå™¨ä¸æ”¯æŒæƒé™API</div>';
                log('æƒé™APIä¸æ”¯æŒ: ' + error.message, 'warning');
            }
        }

        async function requestCameraPermission() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });

                document.getElementById('permissionStatus').innerHTML =
                    '<div class="success">âœ… æ‘„åƒå¤´æƒé™è¯·æ±‚æˆåŠŸ</div>';
                log('æ‘„åƒå¤´æƒé™è¯·æ±‚æˆåŠŸ');

                // å…³é—­æµ‹è¯•æµ
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            } catch (error) {
                const status = document.getElementById('permissionStatus');
                status.innerHTML = `<div class="error">âŒ æ‘„åƒå¤´æƒé™è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
                log('æ‘„åƒå¤´æƒé™è¯·æ±‚å¤±è´¥: ' + error.message, 'error');

                // æä¾›å…·ä½“é”™è¯¯è§£å†³æ–¹æ¡ˆ
                if (error.name === 'NotAllowedError') {
                    log('è§£å†³æ–¹æ¡ˆ: åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»æ‘„åƒå¤´å›¾æ ‡ï¼Œé€‰æ‹©"å…è®¸"', 'info');
                } else if (error.name === 'NotFoundError') {
                    log('è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦æ­£ç¡®è¿æ¥', 'info');
                } else if (error.name === 'NotReadableError') {
                    log('è§£å†³æ–¹æ¡ˆ: æ‘„åƒå¤´å¯èƒ½è¢«å…¶ä»–åº”ç”¨å ç”¨', 'info');
                }
            }
        }

        async function enumerateDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const deviceList = document.getElementById('deviceList');

                if (videoDevices.length === 0) {
                    deviceList.innerHTML = '<div class="error">âŒ æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡</div>';
                    log('æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡', 'error');
                } else {
                    let html = `<div class="success">âœ… æ‰¾åˆ° ${videoDevices.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡:</div>`;
                    videoDevices.forEach((device, index) => {
                        html += `<div class="info">æ‘„åƒå¤´ ${index + 1}: ${device.label || 'æœªå‘½åè®¾å¤‡'} (ID: ${device.deviceId})</div>`;
                        log(`æ‘„åƒå¤´ ${index + 1}: ${device.label || 'æœªå‘½åè®¾å¤‡'}`);
                    });
                    deviceList.innerHTML = html;
                }
            } catch (error) {
                document.getElementById('deviceList').innerHTML =
                    `<div class="error">âŒ è®¾å¤‡æšä¸¾å¤±è´¥: ${error.message}</div>`;
                log('è®¾å¤‡æšä¸¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function startCameraTest() {
            const video = document.getElementById('cameraTest');
            const status = document.getElementById('testStatus');

            try {
                // é¦–å…ˆåœæ­¢ç°æœ‰æµ
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // è·å–æ–°çš„æ‘„åƒå¤´æµ
                const constraints = {
                    video: {
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        facingMode: 'user'
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                status.innerHTML = '<div class="success">âœ… æ‘„åƒå¤´æµ‹è¯•ä¸­... å¦‚æœèƒ½çœ‹åˆ°ç”»é¢ï¼Œè¯´æ˜æ‘„åƒå¤´å·¥ä½œæ­£å¸¸</div>';
                log('æ‘„åƒå¤´æµ‹è¯•å¼€å§‹');

                // æ£€æŸ¥è§†é¢‘æµçŠ¶æ€
                video.onloadedmetadata = () => {
                    log(`è§†é¢‘æµä¿¡æ¯: ${video.videoWidth}x${video.videoHeight}`);
                };

                video.onerror = (error) => {
                    status.innerHTML = '<div class="error">âŒ è§†é¢‘æ’­æ”¾é”™è¯¯</div>';
                    log('è§†é¢‘æ’­æ”¾é”™è¯¯: ' + error, 'error');
                };

            } catch (error) {
                status.innerHTML = `<div class="error">âŒ æ‘„åƒå¤´æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                log('æ‘„åƒå¤´æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        function stopCameraTest() {
            const video = document.getElementById('cameraTest');
            const status = document.getElementById('testStatus');

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;

                status.innerHTML = '<div class="info">â„¹ï¸ æ‘„åƒå¤´æµ‹è¯•å·²åœæ­¢</div>';
                log('æ‘„åƒå¤´æµ‹è¯•åœæ­¢');
            } else {
                status.innerHTML = '<div class="warning">âš ï¸ æ‘„åƒå¤´æœªè¿è¡Œ</div>';
            }
        }

        function checkBrowserCompatibility() {
            const info = document.getElementById('browserInfo');
            let html = '';
            let issues = [];

            // æ£€æŸ¥getUserMediaæ”¯æŒ
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                html += '<div class="success">âœ… æ”¯æŒ getUserMedia API</div>';
                log('getUserMedia API: æ”¯æŒ');
            } else {
                html += '<div class="error">âŒ ä¸æ”¯æŒ getUserMedia API</div>';
                log('getUserMedia API: ä¸æ”¯æŒ', 'error');
                issues.push('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API');
            }

            // æ£€æŸ¥HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            if (isSecure) {
                html += '<div class="success">âœ… å®‰å…¨è¿æ¥ (HTTPS/Localhost)</div>';
                log('å®‰å…¨è¿æ¥: ' + location.protocol);
            } else {
                html += '<div class="warning">âš ï¸ éå®‰å…¨è¿æ¥ï¼Œæ‘„åƒå¤´å¯èƒ½æ— æ³•å·¥ä½œ</div>';
                log('å®‰å…¨è¿æ¥: éHTTPSè¿æ¥', 'warning');
                issues.push('éœ€è¦HTTPSæˆ–localhost');
            }

            // æµè§ˆå™¨ä¿¡æ¯
            const browserInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform
            };

            html += '<div class="info">æµè§ˆå™¨: ' + browserInfo.userAgent + '</div>';
            log('æµè§ˆå™¨: ' + browserInfo.userAgent);

            // æ£€æŸ¥æ˜¯å¦ä¸ºæ”¯æŒçš„æµè§ˆå™¨
            const supportedBrowsers = ['Chrome', 'Firefox', 'Edge', 'Safari'];
            const isSupported = supportedBrowsers.some(browser =>
                browserInfo.userAgent.includes(browser)
            );

            if (isSupported) {
                html += '<div class="success">âœ… å—æ”¯æŒçš„æµè§ˆå™¨</div>';
                log('æµè§ˆå™¨å…¼å®¹æ€§: æ”¯æŒ');
            } else {
                html += '<div class="warning">âš ï¸ å¯èƒ½ä¸æ”¯æŒçš„æµè§ˆå™¨</div>';
                log('æµè§ˆå™¨å…¼å®¹æ€§: å¯èƒ½ä¸æ”¯æŒ', 'warning');
                issues.push('æ¨èä½¿ç”¨Chromeã€Firefoxã€Edgeæˆ–Safari');
            }

            if (issues.length > 0) {
                html += '<div class="error">å‘ç°é—®é¢˜: ' + issues.join(', ') + '</div>';
            }

            info.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€äº›æ£€æŸ¥
        window.addEventListener('load', () => {
            log('æ‘„åƒå¤´è¯Šæ–­å·¥å…·å·²åŠ è½½');
            checkBrowserCompatibility();
            log('è¯·æŒ‰ç…§æ­¥éª¤ä¾æ¬¡æµ‹è¯•å„é¡¹åŠŸèƒ½');
        });
    </script>
</body>
</html>