# PostureScan Pro 平台系统架构文档

## 文档信息
- **文档版本**: v2.0.0
- **创建日期**: 2025-12-07
- **文档类型**: 系统架构设计文档
- **适用范围**: PostureScan Pro 体态评估平台

---

## 目录

1. [系统架构总览](#1-系统架构总览)
2. [技术架构层次](#2-技术架构层次)
3. [核心功能模块架构](#3-核心功能模块架构)
4. [数据流架构](#4-数据流架构)
5. [进程间通信架构](#5-进程间通信架构)
6. [状态管理架构](#6-状态管理架构)
7. [AI计算引擎架构](#7-ai计算引擎架构)
8. [数据持久化架构](#8-数据持久化架构)
9. [前端组件架构](#9-前端组件架构)
10. [安全架构](#10-安全架构)

---

## 1. 系统架构总览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          PostureScan Pro 平台                            │
│                         (Electron Desktop Application)                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
         ┌──────────▼──────────┐         ┌─────────▼──────────┐
         │   主进程 (Main)      │         │  渲染进程 (Renderer) │
         │   Node.js Runtime    │◄────────┤   React SPA         │
         └──────────┬──────────┘   IPC    └─────────┬──────────┘
                    │                               │
         ┌──────────▼──────────┐         ┌─────────▼──────────┐
         │  数据库连接池        │         │  MediaPipe Engine   │
         │  (MySQL Pool)       │         │  (Pose Detection)   │
         └──────────┬──────────┘         └─────────┬──────────┘
                    │                               │
         ┌──────────▼──────────┐         ┌─────────▼──────────┐
         │   MySQL Database    │         │   Webcam Stream     │
         │  - patients         │         │   (720p/1080p)      │
         │  - assessments      │         └─────────────────────┘
         │  - exercises        │
         └─────────────────────┘
```

### 1.2 架构特点

| 特点 | 说明 |
|------|------|
| **跨平台性** | 基于Electron，支持Windows、macOS、Linux |
| **前后端分离** | React前端 + Node.js后端，通过IPC通信 |
| **实时计算** | MediaPipe实时姿态检测，30-60fps |
| **离线运行** | 本地数据库，无需联网（模型需首次加载） |
| **模块化设计** | 功能模块解耦，易于扩展和维护 |
| **状态隔离** | Context API管理全局状态，避免状态污染 |

---

## 2. 技术架构层次

### 2.1 四层架构模型

```
┌──────────────────────────────────────────────────────────────┐
│                    表现层 (Presentation Layer)                │
│  - React Components (UI组件)                                  │
│  - CSS Modules (样式)                                         │
│  - React Router (路由)                                        │
└──────────────────────────────────────────────────────────────┘
                            ↓↑
┌──────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Business Logic Layer)          │
│  - 姿态分析算法 (postureCalculator.js)                        │
│  - 运动评估逻辑 (squatUtils.js, bicepCurlUtils.js)           │
│  - 状态机 (Reducer)                                           │
│  - Context Providers (TrainingSessionContext)                │
└──────────────────────────────────────────────────────────────┘
                            ↓↑
┌──────────────────────────────────────────────────────────────┐
│                    服务层 (Service Layer)                     │
│  - IPC通信服务 (window.api.*)                                 │
│  - MediaPipe服务 (Pose Detection)                            │
│  - 摄像头服务 (Camera Utils)                                  │
└──────────────────────────────────────────────────────────────┘
                            ↓↑
┌──────────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access Layer)             │
│  - MySQL连接池 (mysql2/promise)                               │
│  - IPC Handlers (main.js)                                    │
│  - 数据库CRUD操作                                             │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈映射

| 层次 | 技术栈 | 文件/目录 |
|------|--------|-----------|
| **表现层** | React 18.2, CSS3, React Router 6 | `/src/components`, `/src/pages` |
| **业务逻辑层** | JavaScript ES6+, React Hooks | `/src/modules/*/utils.js`, `/src/contexts` |
| **服务层** | MediaPipe, IPC, Webcam API | `app/preload.js`, MediaPipe SDK |
| **数据访问层** | MySQL2, Node.js | `app/main.js`, MySQL数据库 |

---

## 3. 核心功能模块架构

### 3.1 模块划分总览

```
PostureScan Pro
├── 人员管理模块 (Patient Management)
├── 静态体态评估模块 (Static Posture Assessment)
├── 运动纠正模块 (Motion Correction)
│   ├── 深蹲训练子模块 (Squat Training)
│   └── 二头弯举子模块 (Bicep Curl)
├── 脊柱曲率分析模块 (Spinal Curvature Analysis)
├── 报告管理模块 (Report Management)
├── 数据展示模块 (Data Visualization)
└── 系统管理模块 (System Management)
```

### 3.2 人员管理模块架构

#### 3.2.1 模块职责
- 人员信息的增删改查（CRUD）
- 人员列表展示与搜索
- 人员详情页与评估历史关联

#### 3.2.2 组件架构

```
Dashboard (人员管理主页)
├── 数据获取: useEffect + window.api.getPatients()
├── 状态管理: useState (patients, isLoading, error)
├── 子组件:
│   ├── PatientTable (人员列表表格)
│   │   ├── 行点击 → 导航到PatientDetailPage
│   │   ├── 编辑按钮 → 打开PatientFormModal
│   │   └── 删除按钮 → 确认删除
│   └── PatientFormModal (人员表单弹窗)
│       ├── 新增模式: patient = null
│       └── 编辑模式: patient = {...}
└── 操作流程:
    ├── 添加人员: handleSavePatient → window.api.addPatient
    ├── 更新人员: handleSavePatient → window.api.updatePatient
    └── 删除人员: handleDeletePatient → window.api.deletePatient
```

#### 3.2.3 数据流图

```
用户操作 → React Component → IPC调用 → Main进程 → MySQL数据库
   ↓                                                      │
   └──────────────── 更新UI ← 返回数据 ←─────────────────┘
```

#### 3.2.4 核心代码结构

```javascript
// Dashboard.js 核心逻辑
const Dashboard = () => {
  const [patients, setPatients] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  
  // 数据获取
  useEffect(() => {
    const fetchPatients = async () => {
      const data = await window.api.getPatients();
      setPatients(data);
    };
    fetchPatients();
  }, []);
  
  // CRUD操作
  const handleSavePatient = async (patientData) => {
    if (editingPatient) {
      await window.api.updatePatient({...editingPatient, ...patientData});
    } else {
      await window.api.addPatient(patientData);
    }
  };
  
  const handleDeletePatient = async (id) => {
    await window.api.deletePatient(id);
  };
};
```

#### 3.2.5 API接口定义

| 方法 | IPC通道 | 参数 | 返回值 |
|------|---------|------|--------|
| `getPatients()` | `db:get-patients` | 无 | `Array<Patient>` |
| `getPatientById(id)` | `db:get-patient-by-id` | `number` | `Patient \| null` |
| `addPatient(patient)` | `db:add-patient` | `PatientInput` | `Patient` |
| `updatePatient(patient)` | `db:update-patient` | `Patient` | `Patient` |
| `deletePatient(id)` | `db:delete-patient` | `number` | `number` |

---

### 3.3 静态体态评估模块架构

#### 3.3.1 模块职责
- 实时摄像头捕获
- MediaPipe人体33个关键点检测
- 多平面角度计算（矢状面、冠状面、横断面）
- 平衡指数计算
- 姿态建议生成

#### 3.3.2 组件架构

```
PostureCapture (体态捕获主组件)
├── 初始化层
│   ├── MediaPipe Pose初始化
│   │   ├── locateFile: CDN模型加载
│   │   ├── setOptions: 模型参数配置
│   │   └── onResults: 结果回调
│   └── Camera初始化
│       ├── getUserMedia: 请求摄像头权限
│       └── Camera实例: 帧回调
│
├── 计算层 (postureCalculator.js)
│   ├── calculateAngle3D: 3D角度计算
│   ├── calculateRoll: 滚转角计算
│   ├── calculatePosture: 姿态计算主函数
│   │   ├── 矢状面角度 (head, neck, trunk, pelvis)
│   │   ├── 冠状面角度 (shoulders, pelvis, head)
│   │   ├── 横断面角度 (shoulders, pelvis)
│   │   └── 平衡指数 (overall, sagittal, coronal, transverse)
│   └── getPostureAdvice: 姿态建议生成
│
├── 渲染层
│   ├── Video元素: 摄像头流
│   ├── Canvas元素: 骨骼叠加绘制
│   │   ├── drawConnectors: 骨骼连线
│   │   ├── drawLandmarks: 关键点绘制
│   │   └── drawCanvas: 自定义绘制逻辑
│   └── AnalysisPanel: 数据展示面板
│
└── 交互层
    ├── CaptureToolbar: 工具栏
    │   ├── 开始/停止摄像头
    │   ├── 校准功能
    │   ├── 拍照捕获
    │   └── 保存报告
    └── SettingsPanel: 设置面板
        ├── 水平翻转
        ├── 显示骨骼
        ├── 显示关键点
        └── 显示角度标注
```

#### 3.3.3 数据处理流程

```
摄像头帧 → MediaPipe Pose → 33个关键点 → 姿态计算器 → 角度数据
   ↓                                                          ↓
Video元素                                              PostureData状态
   ↓                                                          ↓
Canvas绘制 ← 骨骼叠加 ← DrawingUtils              AnalysisPanel展示
```

#### 3.3.4 关键算法

**3D角度计算算法**:
```javascript
const calculateAngle3D = (p1, p2, p3) => {
  // p2为顶点，p1和p3为两侧点
  const v1 = { x: p1.x - p2.x, y: p1.y - p2.y, z: p1.z - p2.z };
  const v2 = { x: p3.x - p2.x, y: p3.y - p2.y, z: p3.z - p2.z };
  
  // 向量点积
  const dot = v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
  
  // 向量模长
  const mag1 = Math.sqrt(v1.x ** 2 + v1.y ** 2 + v1.z ** 2);
  const mag2 = Math.sqrt(v2.x ** 2 + v2.y ** 2 + v2.z ** 2);
  
  // 反余弦计算角度
  const angleRad = Math.acos(dot / (mag1 * mag2));
  return angleRad * (180 / Math.PI);
};
```

**平衡指数计算**:
```javascript
// 冠状面平衡 (左右平衡)
const coronalDeviation = Math.abs(shoulders.value) + Math.abs(pelvis.value);
balance.coronal.value = Math.max(0, 100 - coronalDeviation * 5);

// 矢状面平衡 (前后平衡)
const sagittalDeviation = Math.abs(head.value);
balance.sagittal.value = Math.max(0, 100 - sagittalDeviation * 4);

// 总体平衡 (加权平均)
balance.overall.value = (balance.coronal.value * 0.6) + (balance.sagittal.value * 0.4);
```

#### 3.3.5 MediaPipe配置参数

| 参数 | 值 | 说明 |
|------|-----|------|
| modelComplexity | 1 | 模型复杂度 (0=轻量/1=平衡/2=精准) |
| smoothLandmarks | true | 启用关键点平滑 |
| enableSegmentation | false | 禁用人体分割（提高性能） |
| minDetectionConfidence | 0.5 | 最小检测置信度 |
| minTrackingConfidence | 0.5 | 最小追踪置信度 |

---

### 3.4 运动纠正模块架构

#### 3.4.1 深蹲训练子模块

**模块职责**:
- 实时监测深蹲动作
- 自动计数
- 动作质量评分
- 实时反馈提示
- 训练报告生成

**状态机架构**:
```
┌─────────┐
│ CONFIG  │ (配置阶段)
└────┬────┘
     │ START_SESSION (用户设定目标次数)
     ▼
┌─────────────┐
│ INITIALIZING│ (初始化，检测稳定姿态)
└──────┬──────┘
       │ INITIALIZED (检测到稳定站立)
       ▼
┌──────────┐ ◄──────────────────┐
│   IDLE   │ (准备状态)          │
└────┬─────┘                     │
     │ START_SQUAT               │ 继续下一次
     │ (膝盖角度 < 160°)         │
     ▼                           │
┌───────────┐                    │
│ SQUATTING │ (下蹲中)            │
└─────┬─────┘                    │
      │ END_SQUAT                │
      │ (膝盖角度 > 165°)         │
      ▼                          │
┌──────────┐                     │
│ ANALYZING│ (分析动作质量)       │
└────┬─────┘                     │
     │ 分析完成                   │
     ├──────────────────────────┘ (未达目标)
     │
     │ 达到目标次数
     ▼
┌──────────┐
│ COMPLETE │ (训练完成)
└──────────┘
```

**组件架构**:
```
StandardSquat (深蹲主组件)
├── 状态管理: useReducer(squatReducer)
│   ├── sessionState: 当前状态
│   ├── targetCount: 目标次数
│   ├── squatCount: 完成次数
│   ├── feedback: 实时反馈文本
│   └── liveMetrics: 实时指标数据
│
├── MediaPipe集成
│   ├── Pose初始化
│   ├── Camera启动
│   └── onResults回调
│       ├── 关键点提取
│       ├── 角度计算
│       └── 状态判断
│
├── 业务逻辑 (squatUtils.js)
│   ├── calculateAngle: 角度计算
│   └── analyzeSquatPerformance: 动作评分
│       ├── 深度检测 (minKneeAngle < 100°)
│       ├── 背部姿态检测 (hipAngle vs kneeAngle)
│       └── 评分: GOOD / SHALLOW / POOR
│
├── 视图层
│   ├── SquatSetup: 配置界面
│   ├── SquattingView: 训练界面
│   │   ├── Webcam + Canvas
│   │   ├── MetricsOverlay: 指标叠加
│   │   └── 结束训练按钮
│   └── SessionReport: 报告界面
│
└── 训练保护 (TrainingSessionContext)
    ├── startTraining('squat'): 标记训练中
    ├── endTraining(): 结束训练
    └── 导航拦截: 防止中途切换页面
```

**深蹲评分算法**:
```javascript
export const analyzeSquatPerformance = (squatFrames) => {
  // 1. 最小帧数检查
  if (squatFrames.length < 5) {
    return { isValid: false, report: ['动作幅度太小'] };
  }

  let minKneeAngle = 180;
  let backWasNotStraight = false;

  // 2. 遍历所有帧，提取关键指标
  for (const frame of squatFrames) {
    if (frame.avgKneeAngle < minKneeAngle) {
      minKneeAngle = frame.avgKneeAngle;
    }
    // 髋角度应小于膝角度（背部挺直）
    if (frame.avgHipAngle < frame.avgKneeAngle - 15) {
      backWasNotStraight = true;
    }
  }

  // 3. 评分逻辑
  let isValid = true;
  const report = [];

  // 深度评估
  if (minKneeAngle > 100) {
    report.push(`深蹲深度不足 (${minKneeAngle.toFixed(0)}°)`);
    isValid = false;
  } else {
    report.push(`深度达标 (${minKneeAngle.toFixed(0)}°)`);
  }

  // 背部姿态评估
  if (backWasNotStraight) {
    report.push('请注意保持背部挺直');
  } else {
    report.push('背部姿态良好');
  }

  return { isValid, report };
};
```

**实时角度监测**:
```javascript
// 在onResults回调中
const onResults = useCallback((results) => {
  if (!results.poseLandmarks) return;
  
  const landmarks = results.poseLandmarks;
  
  // 提取关键关节点
  const leftHip = landmarks[23];
  const leftKnee = landmarks[25];
  const leftAnkle = landmarks[27];
  const rightHip = landmarks[24];
  const rightKnee = landmarks[26];
  const rightAnkle = landmarks[28];
  const leftShoulder = landmarks[11];
  const rightShoulder = landmarks[12];
  
  // 计算膝盖角度
  const leftKneeAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
  const rightKneeAngle = calculateAngle(rightHip, rightKnee, rightAnkle);
  const avgKneeAngle = (leftKneeAngle + rightKneeAngle) / 2;
  
  // 计算髋部角度（躯干）
  const leftHipAngle = calculateAngle(leftShoulder, leftHip, leftKnee);
  const rightHipAngle = calculateAngle(rightShoulder, rightHip, rightKnee);
  const avgHipAngle = (leftHipAngle + rightHipAngle) / 2;
  
  // 状态机逻辑
  switch (state.sessionState) {
    case 'IDLE':
      if (avgKneeAngle < 160) {
        dispatch({ type: 'START_SQUAT' });
        squatFrames.current = [];
      }
      break;
      
    case 'SQUATTING':
      // 记录帧数据
      squatFrames.current.push({ avgKneeAngle, avgHipAngle });
      
      // 检测起身
      if (avgKneeAngle > 165) {
        dispatch({ type: 'END_SQUAT' });
      }
      break;
  }
}, [state.sessionState]);
```

#### 3.4.2 二头弯举子模块

**模块职责**:
- 手臂弯举动作监测
- 动作范围评估（ROM）
- 稳定性检测
- 实时计数与反馈

**组件架构**:
```
BicepCurlAnalysisPage (二头弯举主组件)
├── 状态管理: useReducer
│   ├── sessionState: CONFIG → IDLE → ACTION → ANALYZING → COMPLETE
│   ├── repCount: 完成次数
│   └── liveMetrics: 肘部角度、肩部稳定性
│
├── MediaPipe集成 (同深蹲)
│
├── 业务逻辑 (bicepCurlUtils.js)
│   ├── calculateAngle: 肘部角度
│   └── analyzeBicepCurlPerformance: 动作评分
│       ├── 伸展度检测 (maxElbowAngle > 145°)
│       ├── 弯举高度检测 (minElbowAngle < 65°)
│       ├── 大臂稳定性检测 (肘部位移 < 30% 臂长)
│       └── 综合评分
│
├── 视图层
│   ├── ExerciseHUD: 抬头显示
│   │   ├── 当前次数
│   │   ├── 目标次数
│   │   └── 实时角度
│   ├── DiagramOverlay: 姿势图示叠加
│   │   ├── 左侧标准姿势图
│   │   ├── 右侧标准姿势图
│   │   └── 连线高亮（肩-肘-腕）
│   └── 结束训练按钮
│
└── 训练保护 (同深蹲)
```

**二头弯举评分算法**:
```javascript
export const analyzeBicepCurlPerformance = (frames) => {
  // 参数配置
  const depthThreshold = 65;       // 弯举高度阈值
  const extensionThreshold = 145;  // 伸展度阈值
  const stabilityTolerance = 0.3;  // 稳定性容忍度（30%臂长）

  let minElbowAngle = 180;  // 最小肘部角度（顶峰）
  let maxElbowAngle = 0;    // 最大肘部角度（起始）
  let maxElbowMovement = 0; // 肘部最大位移

  // 计算臂长（用于稳定性检测）
  const firstFrame = frames[0];
  const armLength = Math.hypot(
    firstFrame.shoulder.x - firstFrame.elbow.x,
    firstFrame.shoulder.y - firstFrame.elbow.y
  );
  const stabilityPixelThreshold = armLength * stabilityTolerance;

  // 遍历所有帧
  for (const frame of frames) {
    if (frame.elbowAngle < minElbowAngle) minElbowAngle = frame.elbowAngle;
    if (frame.elbowAngle > maxElbowAngle) maxElbowAngle = frame.elbowAngle;

    // 计算肘部位移
    const elbowMovement = Math.hypot(
      frame.elbow.x - firstFrame.elbow.x,
      frame.elbow.y - firstFrame.elbow.y
    );
    if (elbowMovement > maxElbowMovement) maxElbowMovement = elbowMovement;
  }

  // 评分逻辑
  const report = [];
  let isValid = true;

  // 1. 伸展度评估
  if (maxElbowAngle < extensionThreshold) {
    report.push(`❌ 手臂未充分伸展 (${maxElbowAngle.toFixed(0)}°)`);
    isValid = false;
  } else {
    report.push(`✅ 手臂伸展达标 (${maxElbowAngle.toFixed(0)}°)`);
  }
  
  // 2. 弯举高度评估
  if (minElbowAngle > depthThreshold) {
    report.push(`❌ 弯举高度不足 (${minElbowAngle.toFixed(0)}°)`);
    isValid = false;
  } else {
    report.push(`✅ 弯举高度达标 (${minElbowAngle.toFixed(0)}°)`);
  }

  // 3. 稳定性评估
  if (maxElbowMovement > stabilityPixelThreshold) {
    report.push(`❌ 大臂不稳定，请固定肘部`);
    isValid = false;
  } else {
    report.push(`✅ 大臂稳定性良好`);
  }

  return { isValid, report };
};
```

**DiagramOverlay（姿势图示叠加）架构**:
```javascript
// 标准骨骼布局定义（200x300视图框）
export const SKELETON_LAYOUT = {
  nose: { x: 100, y: 30 },
  left_shoulder: { x: 75, y: 60 },
  right_shoulder: { x: 125, y: 60 },
  left_elbow: { x: 65, y: 95 },
  right_elbow: { x: 135, y: 95 },
  left_wrist: { x: 60, y: 125 },
  right_wrist: { x: 140, y: 125 },
  // ... 其他33个关键点
};

// 二头弯举高亮连接
const BICEP_HIGHLIGHTED_CONNECTIONS = [
  ['left_shoulder', 'left_elbow'],
  ['left_elbow', 'left_wrist'],
  ['right_shoulder', 'right_elbow'],
  ['right_elbow', 'right_wrist'],
];

// DiagramOverlay组件
const DiagramOverlay = ({ side, onJointPositionsUpdate, highlightedConnections }) => {
  // 1. 根据side镜像x坐标（左侧/右侧）
  // 2. 计算SVG元素的实际屏幕坐标
  // 3. 通过onJointPositionsUpdate回调传递给父组件
  // 4. 父组件使用这些坐标绘制连接线到真人关键点
};
```

**MetricsDrawer（指标连线绘制器）**:
```javascript
export function drawMetrics(ctx, lines) {
  lines.forEach(line => {
    const { startX, startY, endX, endY, color, isHighlighted } = line;
    
    // 1. 计算贝塞尔曲线控制点（平滑S曲线）
    const curveFactor = Math.min(distance * 0.3, 80);
    const cp1x = startX + curveFactor;
    const cp2x = endX - curveFactor;
    
    // 2. 绘制发光效果（阴影）
    ctx.shadowColor = color;
    ctx.shadowBlur = 8;
    ctx.bezierCurveTo(cp1x, startY, cp2x, endY, endX, endY);
    
    // 3. 绘制主线（渐变）
    const gradient = ctx.createLinearGradient(startX, startY, endX, endY);
    if (isHighlighted) {
      gradient.addColorStop(0, 'rgba(245, 158, 11, 0.8)'); // 橙色
      gradient.addColorStop(1, 'rgba(251, 191, 36, 1)');
    } else {
      gradient.addColorStop(0, 'rgba(107, 114, 128, 0.6)'); // 灰色
    }
    
    // 4. 绘制连接点（带环状效果）
    drawConnectionPoint(ctx, startX, startY, isHighlighted);
    drawConnectionPoint(ctx, endX, endY, isHighlighted);
  });
}
```

---

### 3.5 脊柱曲率分析模块架构

#### 3.5.1 模块职责
- 侧面脊柱曲线检测
- 曲率角度计算
- 健康状态评估
- 可视化展示

#### 3.5.2 组件架构

```
SpinalCurvature (脊柱曲率主组件)
├── MediaPipe Pose初始化
├── 实时检测循环
│   ├── requestAnimationFrame
│   └── detect函数
│       ├── 读取video帧
│       └── pose.send({image})
│
├── 结果处理 (onResults)
│   ├── 提取关键点
│   │   ├── leftShoulder / rightShoulder
│   │   └── leftHip / rightHip
│   ├── 计算中点
│   │   ├── shoulderMidpoint
│   │   └── hipMidpoint
│   ├── Canvas绘制
│   │   ├── 绘制骨骼
│   │   ├── 绘制脊柱实际线（黄色）
│   │   └── 绘制垂直参考线（白色虚线）
│   └── latestLandmarksRef存储
│
├── 分析功能 (analyzePose)
│   ├── 计算水平偏移
│   │   horizontalOffset = |shoulderX - hipX|
│   ├── 计算脊柱长度
│   │   spineLength = √((Δx)² + (Δy)²)
│   ├── 计算曲率角度
│   │   curvatureAngle = atan(offset / length) * 180/π
│   ├── 健康评估
│   │   ├── < 2°: 正常
│   │   ├── 2-5°: 轻度侧弯
│   │   └── > 5°: 明显侧弯
│   └── 生成报告
│       └── 导航到SpinalCurvatureReport
│
└── 视图层
    ├── Webcam组件
    ├── Canvas覆盖层
    └── 操作按钮
        ├── 开始检测
        ├── 停止检测
        └── 分析姿态
```

#### 3.5.3 曲率计算算法

```javascript
const analyzePose = () => {
  const landmarks = latestLandmarksRef.current;
  
  // 1. 提取关键点
  const leftShoulder = landmarks[11];
  const rightShoulder = landmarks[12];
  const leftHip = landmarks[23];
  const rightHip = landmarks[24];
  
  // 2. 计算中点
  const shoulderMidpoint = {
    x: (leftShoulder.x + rightShoulder.x) / 2,
    y: (leftShoulder.y + rightShoulder.y) / 2
  };
  const hipMidpoint = {
    x: (leftHip.x + rightHip.x) / 2,
    y: (leftHip.y + rightHip.y) / 2
  };
  
  // 3. 计算水平偏移（Canvas坐标系）
  const canvasWidth = canvasRef.current.width;
  const horizontalOffset = Math.abs(
    shoulderMidpoint.x * canvasWidth - hipMidpoint.x * canvasWidth
  );
  
  // 4. 计算脊柱长度（Canvas坐标系）
  const canvasHeight = canvasRef.current.height;
  const spineLength = Math.sqrt(
    Math.pow((shoulderMidpoint.x - hipMidpoint.x) * canvasWidth, 2) +
    Math.pow((shoulderMidpoint.y - hipMidpoint.y) * canvasHeight, 2)
  );
  
  // 5. 计算曲率角度
  const curvatureAngle = Math.atan(horizontalOffset / spineLength) * (180 / Math.PI);
  
  // 6. 健康评估
  let assessment = '';
  let severity = 'normal';
  
  if (curvatureAngle < 2) {
    assessment = '脊柱曲率正常';
    severity = 'normal';
  } else if (curvatureAngle < 5) {
    assessment = '轻度侧弯，建议关注';
    severity = 'mild';
  } else {
    assessment = '明显侧弯，建议就医检查';
    severity = 'severe';
  }
  
  // 7. 生成报告
  const report = {
    curvatureAngle: curvatureAngle.toFixed(2),
    horizontalOffset: horizontalOffset.toFixed(2),
    spineLength: spineLength.toFixed(2),
    assessment,
    severity,
    timestamp: new Date().toISOString()
  };
  
  return report;
};
```

---

### 3.6 报告管理模块架构

#### 3.6.1 模块职责
- 评估报告列表展示
- 报告详情查看
- 报告数据持久化
- 截图保存

#### 3.6.2 组件架构

```
Reports (报告列表主页)
├── 数据获取
│   ├── window.api.getAllAssessments()
│   └── JOIN查询 (assessments + patients)
│
├── 列表展示
│   ├── 人员姓名
│   ├── 评估日期
│   └── 查看按钮 → 导航到ReportDetailPage
│
└── 筛选功能
    ├── 按人员筛选
    └── 按日期范围筛选

ReportDetailPage (报告详情页)
├── 数据获取
│   ├── window.api.getAssessmentById(id)
│   └── 解析JSON: assessment_data
│
├── 数据展示
│   ├── 人员基本信息
│   ├── 评估时间
│   ├── 角度数据
│   │   ├── 矢状面角度表格
│   │   ├── 冠状面角度表格
│   │   └── 横断面角度表格
│   ├── 平衡指数
│   │   ├── 总体平衡
│   │   ├── 矢状面平衡
│   │   ├── 冠状面平衡
│   │   └── 横断面平衡
│   └── 截图展示 (Base64图片)
│
└── 操作按钮
    ├── 导出PDF（未实现）
    └── 返回列表

SessionReport (训练报告组件)
├── 数据结构
│   ├── title: 报告标题
│   ├── summary: 总结
│   └── details: 详细数据数组
│       ├── isValid: 是否有效
│       └── report: 反馈文本数组
│
├── 统计计算
│   ├── validCount: 有效次数
│   ├── totalAttempts: 总尝试次数
│   └── accuracy: 成功率
│
└── 视图层
    ├── 整体表现卡片
    │   ├── 有效次数
    │   ├── 总尝试次数
    │   └── 成功率
    ├── 详细分析列表
    │   └── 每次尝试的反馈
    └── 操作按钮
        └── 再试一次
```

#### 3.6.3 报告数据结构

**静态体态评估报告**:
```javascript
{
  "sagittalAngles": {
    "head": { "value": 5.2, "neutral": 0, "status": "normal" },
    "neck": { "value": 2.1, "neutral": 0, "status": "normal" },
    "trunk": { "value": -3.5, "neutral": 0, "status": "warning" },
    "pelvis": { "value": 1.0, "neutral": 0, "status": "normal" }
  },
  "coronalAngles": {
    "head": { "value": 0.8, "neutral": 0, "status": "normal" },
    "shoulders": { "value": 2.3, "neutral": 0, "status": "warning" },
    "pelvis": null,
    "knees": null
  },
  "transverseAngles": {
    "shoulders": { "value": -1.2, "neutral": 0, "status": "normal" },
    "pelvis": null
  },
  "balanceIndex": {
    "overall": { "value": 85, "status": "good" },
    "sagittal": { "value": 90, "status": "good" },
    "coronal": { "value": 80, "status": "warning" },
    "transverse": { "value": 92, "status": "good" }
  },
  "captureTimestamp": "2025-12-07T10:30:00.000Z"
}
```

**运动训练报告**:
```javascript
{
  "title": "深蹲训练总结",
  "summary": "完成了 8 次有效深蹲，总尝试 10 次",
  "details": [
    {
      "isValid": true,
      "report": ["深度达标 (85°)", "背部姿态良好"]
    },
    {
      "isValid": false,
      "report": ["深蹲深度不足 (105°)", "请注意保持背部挺直"]
    }
    // ... 更多
  ],
  "sessionData": {
    "targetCount": 10,
    "validCount": 8,
    "totalAttempts": 10,
    "accuracy": 80,
    "startTime": "2025-12-07T14:20:00.000Z",
    "endTime": "2025-12-07T14:25:30.000Z"
  }
}
```

---

### 3.7 数据展示模块架构

#### 3.7.1 DatasetShowcase组件架构

```
DatasetShowcase (数据集展示)
├── 数据聚合
│   ├── 获取所有人员
│   ├── 获取所有评估
│   └── 数据统计
│       ├── 总人员数
│       ├── 总评估数
│       ├── 平均年龄
│       └── 性别分布
│
├── 可视化图表 (Chart.js)
│   ├── 人员年龄分布图（柱状图）
│   ├── 性别分布图（饼图）
│   ├── 评估趋势图（折线图）
│   └── 平衡指数分布图（散点图）
│
└── 交互功能
    ├── 图表筛选
    └── 数据导出（未实现）
```

---

## 4. 数据流架构

### 4.1 数据流向总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                 │
│  (用户点击、输入、摄像头操作)                                      │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                     React组件层                                   │
│  - 状态更新 (useState, useReducer)                                │
│  - 事件处理函数 (handleXxx)                                       │
└─────────────┬───────────────────────────────┬───────────────────┘
              ↓                               ↓
    ┌─────────────────┐           ┌───────────────────────┐
    │  IPC调用        │           │  MediaPipe处理        │
    │  (数据库操作)    │           │  (姿态检测)           │
    └────────┬────────┘           └──────────┬────────────┘
             ↓                               ↓
    ┌─────────────────┐           ┌───────────────────────┐
    │  Main进程       │           │  onResults回调        │
    │  (IPC Handlers) │           │  (关键点数据)         │
    └────────┬────────┘           └──────────┬────────────┘
             ↓                               ↓
    ┌─────────────────┐           ┌───────────────────────┐
    │  MySQL数据库    │           │  业务逻辑处理          │
    │  (持久化存储)    │           │  (角度计算、评分)      │
    └────────┬────────┘           └──────────┬────────────┘
             │                               │
             └───────────────┬───────────────┘
                             ↓
                   ┌──────────────────┐
                   │  React状态更新   │
                   │  (触发重渲染)     │
                   └──────────────────┘
                             ↓
                   ┌──────────────────┐
                   │  UI更新显示      │
                   └──────────────────┘
```

### 4.2 关键数据流详解

#### 4.2.1 人员管理数据流

```
添加人员流程:
用户填写表单 → handleSavePatient
              ↓
       window.api.addPatient({name, gender, age, height, weight})
              ↓ (IPC: 'db:add-patient')
       Main进程接收 → ipcMain.handle('db:add-patient')
              ↓
       dbPool.execute('INSERT INTO patients ...')
              ↓
       MySQL插入数据 → 返回insertId
              ↓
       Main进程返回 {id, ...patientData}
              ↓ (IPC返回)
       React组件接收 → setPatients([newPatient, ...patients])
              ↓
       UI重渲染 → 表格显示新人员
```

#### 4.2.2 姿态检测数据流

```
实时检测流程:
摄像头捕获帧 → Camera.onFrame回调
                ↓
         pose.send({image: video})
                ↓
         MediaPipe处理（云端/WASM）
                ↓
         pose.onResults({poseLandmarks: [...]})
                ↓
         React组件onResults回调
                ↓
         提取关键点 → calculatePosture(landmarks)
                ↓
         计算角度、平衡指数
                ↓
         setPostureData(newData) + setAlerts(newAlerts)
                ↓
         UI更新 → Canvas绘制 + AnalysisPanel显示
```

#### 4.2.3 训练报告保存数据流

```
保存报告流程:
用户点击保存 → handleSaveReport
                ↓
         生成报告数据 {patientId, assessmentData, screenshot}
                ↓
         Canvas.toDataURL('image/png') → Base64截图
                ↓
         window.api.addAssessment({...})
                ↓ (IPC: 'db:add-assessment')
         Main进程接收
                ↓
         dbPool.execute('INSERT INTO assessments ...')
                ↓
         MySQL插入 → 返回id
                ↓
         React组件接收 → 导航到报告详情页
```

---

## 5. 进程间通信架构

### 5.1 IPC通信机制

```
┌──────────────────────────────────────────────────────────────┐
│                    渲染进程 (Renderer Process)                │
│                         React应用                             │
└───────────────────────────┬──────────────────────────────────┘
                            │
                            │ window.api.xxx()
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                    预加载脚本 (Preload Script)                │
│              contextBridge.exposeInMainWorld('api', {...})    │
│                                                               │
│  安全桥接层 - 白名单暴露API                                    │
└───────────────────────────┬──────────────────────────────────┘
                            │
                            │ ipcRenderer.invoke(channel, args)
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                      主进程 (Main Process)                    │
│              ipcMain.handle(channel, handler)                 │
│                                                               │
│  业务逻辑层 - 数据库操作、文件系统访问                           │
└───────────────────────────┬──────────────────────────────────┘
                            │
                            │ dbPool.query() / fs操作
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                   外部资源 (External Resources)               │
│              MySQL数据库、文件系统、操作系统API                 │
└──────────────────────────────────────────────────────────────┘
```

### 5.2 IPC接口清单

#### 5.2.1 人员管理接口

| 渲染进程API | IPC通道 | 主进程Handler | 数据库操作 |
|------------|---------|--------------|-----------|
| `getPatients()` | `db:get-patients` | `ipcMain.handle('db:get-patients')` | `SELECT * FROM patients` |
| `getPatientById(id)` | `db:get-patient-by-id` | `ipcMain.handle('db:get-patient-by-id')` | `SELECT * FROM patients WHERE id=?` |
| `addPatient(patient)` | `db:add-patient` | `ipcMain.handle('db:add-patient')` | `INSERT INTO patients VALUES(...)` |
| `updatePatient(patient)` | `db:update-patient` | `ipcMain.handle('db:update-patient')` | `UPDATE patients SET ... WHERE id=?` |
| `deletePatient(id)` | `db:delete-patient` | `ipcMain.handle('db:delete-patient')` | `DELETE FROM patients WHERE id=?` |

#### 5.2.2 评估报告接口

| 渲染进程API | IPC通道 | 数据库操作 |
|------------|---------|-----------|
| `addAssessment({patientId, assessmentData, screenshot})` | `db:add-assessment` | `INSERT INTO assessments` |
| `getAllAssessments()` | `db:get-all-assessments` | `SELECT a.*, p.name FROM assessments a JOIN patients p` |
| `getAssessmentById(id)` | `db:get-assessment-by-id` | `SELECT * FROM assessments WHERE id=?` |
| `getAssessmentsByPatientId(patientId)` | `db:get-assessments-by-patient-id` | `SELECT * FROM assessments WHERE patient_id=?` |

#### 5.2.3 运动项目接口

| 渲染进程API | IPC通道 | 数据库操作 |
|------------|---------|-----------|
| `getAllExercises()` | `db:get-all-exercises` | `SELECT e.*, ec.name FROM exercises e JOIN exercise_categories ec` |
| `getExerciseBySlug(slug)` | `db:get-exercise-by-slug` | `SELECT * FROM exercises WHERE slug=?` |

### 5.3 IPC安全机制

**Preload.js安全暴露**:
```javascript
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('api', {
  // 只暴露必要的API，不暴露ipcRenderer本身
  getPatients: () => ipcRenderer.invoke('db:get-patients'),
  addPatient: (patient) => ipcRenderer.invoke('db:add-patient', patient),
  // ... 其他API
});

// ❌ 不安全的做法（暴露整个ipcRenderer）
// window.ipcRenderer = ipcRenderer; // 危险！
```

**Main.js错误处理**:
```javascript
ipcMain.handle('db:get-patients', async () => {
  if (!dbPool) {
    throw new Error("Database pool is not available.");
  }
  
  try {
    const [rows] = await dbPool.query('SELECT * FROM patients');
    return rows;
  } catch (error) {
    console.error("IPC_ERROR: Failed to get patients.", error);
    throw error; // 错误会传递回渲染进程
  }
});
```

---

## 6. 状态管理架构

### 6.1 状态管理层次

```
全局状态 (Context API)
├── TrainingSessionContext
│   ├── isTrainingActive: boolean
│   ├── exerciseType: 'squat' | 'bicep-curl' | null
│   ├── startTraining(type): void
│   └── endTraining(): void
│
└── (未来扩展)
    ├── UserContext (用户偏好设置)
    └── ThemeContext (主题切换)

组件级状态 (useState / useReducer)
├── Dashboard
│   ├── patients: Array<Patient>
│   ├── isLoading: boolean
│   └── error: string | null
│
├── PostureCapture
│   ├── poseResults: MediaPipe.Results
│   ├── postureData: PostureData
│   ├── alerts: Record<string, string>
│   ├── isCameraActive: boolean
│   └── settings: CaptureSettings
│
├── StandardSquat / BicepCurl
│   ├── state: SquatState (通过useReducer管理)
│   │   ├── sessionState: string
│   │   ├── count: number
│   │   ├── feedback: string
│   │   └── liveMetrics: Metrics
│   └── settings: ExerciseSettings
│
└── Reports
    ├── assessments: Array<Assessment>
    └── selectedAssessment: Assessment | null
```

### 6.2 TrainingSessionContext详解

**设计目的**:
- 全局追踪训练状态，防止用户训练中途切换页面
- 提供统一的训练会话管理接口
- 支持多种运动类型的区分

**实现**:
```javascript
// contexts/TrainingSessionContext.js
import React, { createContext, useContext, useState, useCallback } from 'react';

const TrainingSessionContext = createContext();

export const useTrainingSession = () => {
  const context = useContext(TrainingSessionContext);
  if (!context) {
    throw new Error('useTrainingSession must be used within TrainingSessionProvider');
  }
  return context;
};

export const TrainingSessionProvider = ({ children }) => {
  const [isTrainingActive, setIsTrainingActive] = useState(false);
  const [exerciseType, setExerciseType] = useState(null);

  const startTraining = useCallback((type) => {
    setIsTrainingActive(true);
    setExerciseType(type);
    console.log(`[TrainingSession] Started: ${type}`);
  }, []);

  const endTraining = useCallback(() => {
    console.log(`[TrainingSession] Ended: ${exerciseType}`);
    setIsTrainingActive(false);
    setExerciseType(null);
  }, [exerciseType]);

  const value = {
    isTrainingActive,
    exerciseType,
    startTraining,
    endTraining,
  };

  return (
    <TrainingSessionContext.Provider value={value}>
      {children}
    </TrainingSessionContext.Provider>
  );
};
```

**使用方式**:
```javascript
// App.js
function App() {
  return (
    <Router>
      <TrainingSessionProvider>
        <Layout>
          <Routes>...</Routes>
        </Layout>
      </TrainingSessionProvider>
    </Router>
  );
}

// StandardSquat.js
const StandardSquat = () => {
  const { startTraining, endTraining } = useTrainingSession();
  
  useEffect(() => {
    const isTrainingState = ['INITIALIZING', 'IDLE', 'SQUATTING', 'ANALYZING'].includes(state.sessionState);
    if (isTrainingState) {
      startTraining('squat');
    } else if (state.sessionState === 'COMPLETE') {
      endTraining();
    }
  }, [state.sessionState, startTraining, endTraining]);
};

// Layout.js (导航拦截)
const Layout = ({ children }) => {
  const { isTrainingActive, exerciseType } = useTrainingSession();
  
  const handleNavigation = (item) => {
    if (isTrainingActive && item.path !== location.pathname) {
      // 显示警告弹窗
      setShowWarningModal(true);
      return;
    }
    navigate(item.path);
  };
};
```

### 6.3 Reducer状态机模式

**深蹲训练Reducer**:
```javascript
const initialState = {
  sessionState: 'CONFIG',
  targetCount: 10,
  squatCount: 0,
  feedback: '请设定目标次数并开始训练。',
  lastSquatReport: null,
  sessionReport: null,
  liveMetrics: [],
};

function squatReducer(state, action) {
  switch (action.type) {
    case 'START_SESSION':
      return {
        ...initialState,
        targetCount: action.payload.targetCount,
        sessionState: 'INITIALIZING',
        feedback: '正在初始化，请在画面中保持稳定...',
      };
    
    case 'INITIALIZED':
      return {
        ...state,
        sessionState: 'IDLE',
        feedback: '准备好后，请开始深蹲。'
      };
    
    case 'START_SQUAT':
      return {
        ...state,
        sessionState: 'SQUATTING',
        feedback: '下蹲中...'
      };
    
    case 'END_SQUAT':
      return {
        ...state,
        sessionState: 'ANALYZING',
        feedback: '分析中...'
      };
    
    case 'SQUAT_ANALYZED':
      const newCount = action.payload.isValid ? state.squatCount + 1 : state.squatCount;
      const isComplete = newCount >= state.targetCount;
      
      return {
        ...state,
        squatCount: newCount,
        lastSquatReport: action.payload.report,
        sessionState: isComplete ? 'COMPLETE' : 'IDLE',
        feedback: isComplete ? '训练完成！' : action.payload.feedback
      };
    
    case 'END_SESSION':
      return {
        ...state,
        sessionState: 'COMPLETE'
      };
    
    case 'UPDATE_LIVE_METRICS':
      return {
        ...state,
        liveMetrics: action.payload
      };
    
    default:
      return state;
  }
}
```

---

## 7. AI计算引擎架构

### 7.1 MediaPipe Pose引擎

**架构层次**:
```
┌────────────────────────────────────────────────────────┐
│              MediaPipe Pose Detection                  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐ │
│  │  BlazePose模型 (Google研发)                       │ │
│  │  - 轻量级CNN网络                                   │ │
│  │  - 支持实时检测 (30-60fps)                        │ │
│  │  - 33个3D关键点输出                               │ │
│  └──────────────────────────────────────────────────┘ │
│                       ↓↑                               │
│  ┌──────────────────────────────────────────────────┐ │
│  │  WebAssembly运行时 (浏览器端)                     │ │
│  │  - 模型从CDN加载                                  │ │
│  │  - WASM高性能计算                                 │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
                         ↓↑
┌────────────────────────────────────────────────────────┐
│              Camera Utils (摄像头工具)              │
│  - 视频流捕获                                       │
│  - 帧率控制                                         │
│  - 分辨率适配                                       │
└────────────────────────────────────────────────────────┘
```

### 7.2 关键点检测流程

```
摄像头捕获 → 图像预处理 → BlazePose模型推理 → 关键点坐标输出
   (720p)      (归一化)      (WASM运行)         (33个点)
                                                    ↓
                                          {x, y, z, visibility}
                                          - x, y: 归一化坐标 [0,1]
                                          - z: 深度(相对于骨盆)
                                          - visibility: 可见度 [0,1]
```

### 7.3 角度计算引擎

**三点角度计算**:
```javascript
// 2D角度计算(用于深蹲、二头弯举)
const calculateAngle = (a, b, c) => {
  // b为顶点,a和c为两侧点
  const radians = Math.atan2(c.y - b.y, c.x - b.x) - 
                  Math.atan2(a.y - b.y, a.x - b.x);
  let angle = Math.abs(radians * 180.0 / Math.PI);
  
  if (angle > 180.0) {
    angle = 360 - angle;
  }
  
  return angle;
};

// 3D角度计算(用于体态评估)
const calculateAngle3D = (p1, p2, p3) => {
  const v1 = {
    x: p1.x - p2.x,
    y: p1.y - p2.y,
    z: p1.z - p2.z
  };
  const v2 = {
    x: p3.x - p2.x,
    y: p3.y - p2.y,
    z: p3.z - p2.z
  };
  
  // 向量点积
  const dot = v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
  
  // 向量模长
  const mag1 = Math.sqrt(v1.x**2 + v1.y**2 + v1.z**2);
  const mag2 = Math.sqrt(v2.x**2 + v2.y**2 + v2.z**2);
  
  // 反余弦计算角度
  const angleRad = Math.acos(dot / (mag1 * mag2));
  return angleRad * (180 / Math.PI);
};
```

### 7.4 姿态评估算法

**矢状面角度计算**(头部前倾):
```javascript
const sagittalHeadAngle = -Math.atan2(
  nose.y - shoulderCenter.y,
  Math.sqrt(
    (nose.x - shoulderCenter.x)**2 + 
    (nose.z - shoulderCenter.z)**2
  )
) * (180 / Math.PI);
```

**冠状面角度计算**(肩膀倾斜):
```javascript
const coronalShoulderAngle = Math.atan2(
  rightShoulder.y - leftShoulder.y,
  rightShoulder.x - leftShoulder.x
) * (180 / Math.PI);
```

**平衡指数计算**:
```javascript
// 冠状面平衡(左右对称)
const coronalDeviation = 
  Math.abs(coronalAngles.shoulders.value) + 
  Math.abs(coronalAngles.pelvis.value || 0);
balance.coronal.value = Math.max(0, 100 - coronalDeviation * 5);

// 矢状面平衡(前后平衡)
const sagittalDeviation = Math.abs(sagittalAngles.head.value);
balance.sagittal.value = Math.max(0, 100 - sagittalDeviation * 4);

// 总体平衡(加权)
balance.overall.value = 
  balance.coronal.value * 0.6 + 
  balance.sagittal.value * 0.4;
```

---

## 8. 数据持久化架构

### 8.1 数据库架构

```
┌─────────────────────────────────────────────────────────────┐
│                    MySQL数据库架构                           │
└─────────────────────────────────────────────────────────────┘

┌────────────────┐         ┌─────────────────────┐
│   patients     │         │  exercise_categories│
├────────────────┤         ├─────────────────────┤
│ id (PK)        │         │ id (PK)             │
│ name           │◄────┐   │ name                │
│ gender         │     │   │ description         │
│ age            │     │   └──────────┬──────────┘
│ height         │     │              │
│ weight         │     │              │ 1:N
│ created_at     │     │              ↓
│ updated_at     │     │   ┌─────────────────────┐
└────────┬───────┘     │   │   exercises         │
         │             │   ├─────────────────────┤
         │ 1:N         │   │ id (PK)             │
         ↓             │   │ category_id (FK)    │
┌────────────────┐     │   │ name                │
│  assessments   │     │   │ slug                │
├────────────────┤     │   │ description         │
│ id (PK)        │     │   └─────────────────────┘
│ patient_id (FK)│─────┘
│ assessment_data│ (JSON)
│ screenshot     │ (LONGTEXT)
│ created_at     │
└────────────────┘
```

### 8.2 数据库连接池配置

```javascript
// app/main.js
const mysql = require('mysql2/promise');

const dbPool = mysql.createPool({
  host: process.env.DB_HOST,           // localhost
  user: process.env.DB_USER,           // root
  password: process.env.DB_PASSWORD,   // 密码
  database: process.env.DB_DATABASE,   // posture_scan_pro_db
  waitForConnections: true,            // 等待可用连接
  connectionLimit: 10,                 // 最大连接数
  queueLimit: 0,                       // 无限队列
  enableKeepAlive: true,               // 保持连接
  keepAliveInitialDelay: 0             // 立即开始心跳
});
```

### 8.3 数据表详细设计

#### 8.3.1 patients表

```sql
CREATE TABLE patients (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL COMMENT '姓名',
  gender ENUM('男','女','其他') NOT NULL COMMENT '性别',
  age INT NOT NULL COMMENT '年龄',
  height DECIMAL(5,2) COMMENT '身高(cm)',
  weight DECIMAL(5,2) COMMENT '体重(kg)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_name (name),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='人员信息表';
```

#### 8.3.2 assessments表

```sql
CREATE TABLE assessments (
  id INT AUTO_INCREMENT PRIMARY KEY,
  patient_id INT NOT NULL COMMENT '关联人员ID',
  assessment_data JSON NOT NULL COMMENT '评估数据(JSON格式)',
  screenshot LONGTEXT COMMENT '截图(Base64编码)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '评估时间',
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE,
  INDEX idx_patient_id (patient_id),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评估报告表';
```

#### 8.3.3 exercise_categories表

```sql
CREATE TABLE exercise_categories (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL COMMENT '分类名称',
  description TEXT COMMENT '分类描述'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='运动分类表';

INSERT INTO exercise_categories (name, description) VALUES
('下肢训练', '腿部和臀部力量训练'),
('上肢训练', '手臂和肩部力量训练');
```

#### 8.3.4 exercises表

```sql
CREATE TABLE exercises (
  id INT AUTO_INCREMENT PRIMARY KEY,
  category_id INT NOT NULL COMMENT '分类ID',
  name VARCHAR(100) NOT NULL COMMENT '运动名称',
  slug VARCHAR(100) UNIQUE NOT NULL COMMENT 'URL友好标识',
  description TEXT COMMENT '运动描述',
  FOREIGN KEY (category_id) REFERENCES exercise_categories(id),
  UNIQUE KEY uk_slug (slug),
  INDEX idx_category_id (category_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='运动项目表';

INSERT INTO exercises (category_id, name, slug, description) VALUES
(1, '标准深蹲', 'standard-squat', '基础下肢力量训练'),
(2, '二头弯举', 'bicep-curl', '手臂二头肌训练');
```

### 8.4 JSON数据结构

**assessment_data字段示例**:
```json
{
  "type": "posture",
  "sagittalAngles": {
    "head": {"value": 5.2, "neutral": 0, "status": "normal"},
    "neck": {"value": 2.1, "neutral": 0, "status": "normal"},
    "trunk": {"value": -3.5, "neutral": 0, "status": "warning"},
    "pelvis": {"value": 1.0, "neutral": 0, "status": "normal"}
  },
  "coronalAngles": {
    "head": {"value": 0.8, "neutral": 0, "status": "normal"},
    "shoulders": {"value": 2.3, "neutral": 0, "status": "warning"},
    "pelvis": null,
    "knees": null
  },
  "transverseAngles": {
    "shoulders": {"value": -1.2, "neutral": 0, "status": "normal"},
    "pelvis": null
  },
  "balanceIndex": {
    "overall": {"value": 85, "status": "good"},
    "sagittal": {"value": 90, "status": "good"},
    "coronal": {"value": 80, "status": "warning"},
    "transverse": {"value": 92, "status": "good"}
  },
  "captureTimestamp": "2025-12-07T10:30:00.000Z"
}
```

---

## 9. 前端组件架构

### 9.1 组件层次结构

```
App
├── TrainingSessionProvider (全局训练状态)
└── Router
    └── Layout (主布局)
        ├── Sidebar (侧边栏导航)
        │   ├── Logo
        │   ├── NavItems
        │   └── Footer
        ├── MainContent (内容区)
        │   └── Routes
        │       ├── Welcome (欢迎页)
        │       ├── Dashboard (人员管理)
        │       │   └── PatientFormModal
        │       ├── PatientDetailPage
        │       ├── PostureCapture (体态捕获)
        │       │   ├── Video + Canvas
        │       │   ├── AnalysisPanel
        │       │   ├── CaptureToolbar
        │       │   └── SettingsPanel
        │       ├── SpinalCurvature (脊柱分析)
        │       │   └── SpinalCurvatureReport
        │       ├── ExerciseSelectionPage (运动选择)
        │       ├── ExerciseAnalysisPage (标准深蹲)
        │       │   ├── SquatSetup
        │       │   ├── Webcam + Canvas
        │       │   ├── DiagramOverlay (左右)
        │       │   ├── MetricsOverlay
        │       │   ├── AngleGauge
        │       │   └── SessionReport
        │       ├── BicepCurlAnalysisPage (二头弯举)
        │       │   └── (同上)
        │       ├── Reports (报告列表)
        │       ├── ReportDetailPage (报告详情)
        │       └── DatasetShowcase (数据展示)
        └── WarningModal (训练警告弹窗)
```

### 9.2 通用组件库

#### 9.2.1 Layout组件

```javascript
Layout
├── 职责
│   ├── 提供统一的页面布局
│   ├── 管理侧边栏导航
│   ├── 训练会话拦截
│   └── 警告模态框显示
│
├── 状态
│   ├── showWarningModal: boolean
│   └── pendingNavigation: string | null
│
├── Context使用
│   ├── useTrainingSession()
│   └── useLocation(), useNavigate()
│
└── 核心逻辑
    ├── handleNavigation(item)
    │   └── 检查isTrainingActive → 显示警告
    ├── confirmNavigation()
    └── cancelNavigation()
```

#### 9.2.2 AnalysisPanel组件

```javascript
AnalysisPanel
├── Props
│   ├── postureData: PostureData
│   ├── alerts: Alerts
│   └── balanceIndex: BalanceIndex
│
├── 显示内容
│   ├── 矢状面角度表格
│   ├── 冠状面角度表格
│   ├── 横断面角度表格
│   ├── 平衡指数仪表盘
│   └── 实时警告提示
│
└── 样式特点
│   ├── 颜色编码(正常/警告/错误)
│   ├── 实时数据更新
│   └── 响应式布局
```

#### 9.2.3 SessionReport组件

```javascript
SessionReport
├── Props
│   ├── report: ReportData
│   └── onRestart: Function
│
├── 数据处理
│   ├── 计算有效次数
│   ├── 计算成功率
│   └── 格式化反馈文本
│
├── 显示内容
│   ├── 整体表现卡片
│   │   ├── 有效次数
│   │   ├── 总尝试次数
│   │   └── 成功率百分比
│   ├── 详细分析列表
│   │   └── 每次尝试的评分
│   └── 操作按钮
│       └── 再试一次
│
└── 样式特点
    ├── 卡片式布局
    ├── 成功/失败视觉区分
    └── 动画过渡效果
```

#### 9.2.4 DiagramOverlay组件

```javascript
DiagramOverlay
├── Props
│   ├── side: 'left' | 'right'
│   ├── onJointPositionsUpdate: Function
│   └── highlightedConnections: Array<[string, string]>
│
├── 功能
│   ├── 渲染标准姿势骨骼图
│   ├── 根据side镜像x坐标
│   ├── 高亮特定连接(如肩-肘-腕)
│   └── 计算并回传关节点屏幕坐标
│
├── 数据结构
│   ├── SKELETON_LAYOUT: 33个关节点坐标
│   ├── DIAGRAM_CONNECTIONS: 骨骼连线定义
│   └── HIGHLIGHTED_CONNECTIONS: 高亮连线集合
│
└── 绘制流程
    ├── SVG viewBox (200x300)
    ├── useLayoutEffect计算屏幕坐标
    └── 回调传递坐标给父组件
```

### 9.3 Canvas绘制架构

```
Canvas绘制流程
├── 1. 清空画布
│   ctx.clearRect(0, 0, width, height)
│
├── 2. 绘制视频帧
│   ctx.drawImage(videoElement, 0, 0, width, height)
│
├── 3. 绘制MediaPipe骨骼
│   ├── drawConnectors(ctx, landmarks, POSE_CONNECTIONS)
│   └── drawLandmarks(ctx, landmarks)
│
├── 4. 绘制自定义指标线
│   └── drawMetrics(ctx, linesToDraw)
│       ├── 贝塞尔曲线连接
│       ├── 渐变色填充
│       └── 发光效果
│
└── 5. 绘制文本标注
    ├── 角度数值
    ├── 实时反馈
    └── 计数显示
```

---

## 10. 安全架构

### 10.1 Electron安全机制

```
┌─────────────────────────────────────────────────────────────┐
│              Electron安全最佳实践                        │
└─────────────────────────────────────────────────────────────┘

1. Context Isolation (上下文隔离)
   ├── webPreferences.contextIsolation = true
   ├── 渲染进程无法直接访问Node.js
   └── 只能通过contextBridge暴露的API通信

2. Node Integration (禁用Node集成)
   ├── webPreferences.nodeIntegration = false
   ├── 渲染进程无require权限
   └── 防止恶意脚本注入

3. Preload Script (预加载脚本)
   ├── 白名单暴露API
   ├── 参数验证
   └── 错误处理

4. CSP (内容安全策略)
   └── 防止XSS攻击(未实现)

5. IPC安全
   ├── 使用ipcRenderer.invoke (异步、安全)
   ├── 避免ipcRenderer.send (同步、不安全)
   └── 主进程验证所有输入
```

### 10.2 数据安全

**敏感信息保护**:
```bash
# .env文件(不提交到Git)
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=******  # 敏感信息
DB_DATABASE=posture_scan_pro_db
```

**SQL注入防护**:
```javascript
// ❌ 不安全(SQL注入风险)
const sql = `SELECT * FROM patients WHERE name = '${name}'`;

// ✅ 安全(参数化查询)
const sql = 'SELECT * FROM patients WHERE name = ?';
const [rows] = await dbPool.execute(sql, [name]);
```

**XSS防护**:
```javascript
// React自动转义,防止XSS
<div>{userInput}</div> // 自动转义HTML标签

// 危险操作(避免使用)
<div dangerouslySetInnerHTML={{__html: userInput}}></div>
```

### 10.3 权限管理

**摄像头权限**:
```javascript
// 请求摄像头权限
try {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { width: { ideal: 1280 }, height: { ideal: 720 } }
  });
  // 授权成功
} catch (err) {
  // 授权失败
  console.error('摄像头权限被拒绝', err);
}
```

**数据库访问权限**:
```javascript
// 只通过IPC访问数据库,渲染进程无直接访问权限
window.api.getPatients(); // ✅ 安全
// mysql.query(...);       // ❌ 渲染进程无法执行
```

---

## 附录

### A. 技术栈版本清单

| 技术 | 版本 | 说明 |
|------|------|------|
| Electron | ^31.0.2 | 桌面应用框架 |
| React | ^18.2.0 | 前端UI框架 |
| React Router DOM | ^6.30.1 | 路由管理 |
| @mediapipe/pose | ^0.5.1675469404 | 姿态检测 |
| @mediapipe/camera_utils | ^0.3.1675466862 | 摄像头工具 |
| @mediapipe/drawing_utils | ^0.3.1675466124 | 绘图工具 |
| mysql2 | ^3.10.1 | MySQL连接 |
| chart.js | ^3.7.0 | 图表库 |
| react-webcam | ^7.2.0 | Webcam组件 |
| react-icons | ^5.5.0 | 图标库 |
| dotenv | ^16.4.5 | 环境变量 |
| concurrently | ^8.2.2 | 并发命令 |
| wait-on | ^7.2.0 | 等待服务 |
| cross-env | ^7.0.3 | 跨平台环境变量 |

### B. 目录结构总览

```
posture-scan-pro/
├── app/                        # Electron主进程
│   ├── main.js                 # 主进程入口
│   └── preload.js              # 预加载脚本
├── public/                     # 静态资源
│   └── index.html
├── src/                        # React源代码
│   ├── index.js                # React入口
│   ├── App.js                  # 根组件
│   ├── components/             # 通用组件
│   │   ├── Layout.js
│   │   ├── Dashboard.js
│   │   ├── Welcome.js
│   │   └── Reports.js
│   ├── pages/                  # 路由页面
│   │   ├── PatientDetailPage.js
│   │   ├── ReportDetailPage.js
│   │   ├── ExerciseSelectionPage.js
│   │   ├── ExerciseAnalysisPage.js
│   │   ├── BicepCurlAnalysisPage.js
│   │   └── DatasetShowcase.js
│   ├── modules/                # 功能模块
│   │   ├── patient/            # 人员管理
│   │   ├── posture/            # 姿态检测
│   │   │   ├── PostureCapture.js
│   │   │   ├── StandardSquat.js
│   │   │   ├── postureCalculator.js
│   │   │   ├── squatUtils.js
│   │   │   ├── bicepCurlUtils.js
│   │   │   └── components/
│   │   │       ├── AnalysisPanel.js
│   │   │       ├── SessionReport.js
│   │   │       ├── DiagramOverlay.js
│   │   │       ├── MetricsOverlay.js
│   │   │       ├── metricsDrawer.js
│   │   │       ├── SpinalCurvature.js
│   │   │       └── ...
│   │   ├── analysis/           # 分析模块
│   │   └── reports/            # 报告模块
│   ├── contexts/               # React Context
│   │   └── TrainingSessionContext.js
│   └── services/               # 服务层
├── .env                        # 环境变量
├── package.json                # 项目配置
└── README.md                   # 项目说明
```

### C. 启动命令速查

```bash
# 安装依赖
npm install

# 仅启动React开发服务器(端口3000)
npm start

# 仅启动Electron窗口
npm run electron

# 同时启动React和Electron(推荐)
npm run electron:start

# 构建生产版本
npm run build

# 打包为桌面应用
npx electron-builder --mac    # macOS
npx electron-builder --win    # Windows
npx electron-builder --linux  # Linux
```

### D. 性能优化建议

1. **MediaPipe优化**
   - 降低modelComplexity(0=最快)
   - 限制检测频率(30fps足够)
   - 减小视频分辨率(720p vs 1080p)

2. **React优化**
   - 使用useMemo缓存计算结果
   - 使用useCallback缓存函数
   - 使用React.memo避免无意义重渲染

3. **Canvas优化**
   - 减少绘制范围
   - 使用requestAnimationFrame
   - 避免频繁的状态更新

4. **数据库优化**
   - 合理使用索引
   - 使用连接池
   - 避免N+1查询

### E. 故障排查清单

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 数据库连接失败 | MySQL未启动/.env配置错误 | 检查MySQL服务/验证.env配置 |
| 摄像头无法访问 | 权限被拒绝/被其他应用占用 | 检查系统权限/关闭其他应用 |
| MediaPipe加载失败 | 网络问题/CDN不可达 | 检查网络/使用本地模型 |
| 白屏问题 | React编译错误/路由配置错误 | 打开DevTools查看错误 |
| 训练数据丢失 | 中途切换页面/组件卸载 | 使用TrainingSessionContext保护 |

---

## 文档版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 2.0.0 | 2025-12-07 | 创建详细系统架构文档 | 开发团队 |

---

**版权所有 © 2025 PostureScan Pro 开发团队**

本文档为内部技术文档,未经授权不得传播或用于商业用途。