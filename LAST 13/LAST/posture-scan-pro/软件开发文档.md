# PostureScan Pro - 体态评估系统开发文档

## 文档版本
- **版本号**: 1.0.0
- **编写日期**: 2025-12-07
- **适用系统版本**: PostureScan Pro v1.0.0

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [系统环境配置](#3-系统环境配置)
4. [数据库设计](#4-数据库设计)
5. [项目结构](#5-项目结构)
6. [核心功能模块](#6-核心功能模块)
7. [开发规范](#7-开发规范)
8. [部署说明](#8-部署说明)
9. [常见问题](#9-常见问题)
10. [维护与更新](#10-维护与更新)

---

## 1. 项目概述

### 1.1 项目简介
PostureScan Pro是一款专业的3D姿态评估桌面应用系统，基于Electron + React架构开发。该系统利用MediaPipe人体姿态检测技术，为医疗专业人员、物理治疗师和健身教练提供精准的姿态评估和治疗跟踪工具。

### 1.2 核心功能
- **人员管理**: 完整的患者/用户信息管理系统（增删改查）
- **实时姿态捕获**: 基于摄像头的实时3D姿态数据捕获
- **静态体态评估**: 多视角（正面、侧面）姿态数据分析
- **运动纠正训练**: 深蹲、二头弯举等动作的实时纠正与计数
- **脊柱曲率分析**: 专业的脊柱健康评估
- **报告生成与管理**: 自动生成专业评估报告，支持历史记录查询
- **数据可视化**: 基于Chart.js的数据展示

### 1.3 应用场景
- 医疗机构体态评估
- 健身房动作指导
- 康复中心物理治疗
- 运动损伤预防

---

## 2. 技术架构

### 2.1 技术栈概览

#### 前端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| React | ^18.2.0 | UI组件化开发 |
| React Router DOM | ^6.30.1 | 路由管理 |
| React Webcam | ^7.2.0 | 摄像头访问 |
| Chart.js | ^3.7.0 | 数据可视化 |
| React Icons | ^5.5.0 | 图标库 |
| Lucide React | ^0.555.0 | 现代图标库 |

#### 后端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Electron | ^31.0.2 | 桌面应用框架 |
| Node.js | 内置 | 运行环境 |
| MySQL2 | ^3.10.1 | 数据库连接 |

#### AI/计算机视觉
| 技术 | 版本 | 用途 |
|------|------|------|
| @mediapipe/pose | ^0.5.1675469404 | 人体姿态检测 |
| @mediapipe/camera_utils | ^0.3.1675466862 | 摄像头工具 |
| @mediapipe/drawing_utils | ^0.3.1675466124 | 绘图工具 |

#### 开发工具
| 技术 | 版本 | 用途 |
|------|------|------|
| React Scripts | 5.0.0 | React开发脚本 |
| Concurrently | ^8.2.2 | 并发运行命令 |
| Wait-on | ^7.2.0 | 等待服务启动 |
| Cross-env | ^7.0.3 | 跨平台环境变量 |
| Dotenv | ^16.4.5 | 环境变量管理 |

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Electron 主进程                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  main.js (窗口管理、IPC通信、数据库连接池)              │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  preload.js (安全API桥接)                             │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↕ IPC通信
┌─────────────────────────────────────────────────────────────┐
│                     React 渲染进程                           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  App.js (路由配置、全局Context)                        │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌──────────────┬──────────────┬──────────────────────────┐  │
│  │   Layout     │  Components  │      Modules             │  │
│  │  (布局框架)  │  (通用组件)  │    (功能模块)            │  │
│  └──────────────┴──────────────┴──────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Pages (路由页面)                                      │  │
│  │  - 人员管理页 - 体态捕获页 - 运动纠正页 - 报告页      │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                    MediaPipe Pose                            │
│        (实时人体关键点检测、骨骼追踪)                         │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                     MySQL 数据库                             │
│  - patients (人员表)  - assessments (评估表)                 │
│  - exercises (运动表) - exercise_categories (分类表)         │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 核心设计模式

#### 2.3.1 Context API全局状态管理
- **TrainingSessionContext**: 管理训练状态，实现训练中导航拦截保护

#### 2.3.2 Reducer状态机
- 深蹲/二头弯举训练流程使用useReducer管理复杂状态
- 状态流转: CONFIG → INITIALIZING → IDLE → ACTION/SQUATTING → ANALYZING → COMPLETE

#### 2.3.3 IPC通信模式
- 主进程通过`ipcMain.handle`暴露数据库操作接口
- 渲染进程通过`window.api.*`调用，由preload.js安全桥接

---

## 3. 系统环境配置

### 3.1 开发环境要求

#### 必需软件
- **Node.js**: v16.0 或更高版本
- **npm**: v8.0 或更高版本
- **MySQL**: v8.0 或更高版本
- **操作系统**: Windows 10+, macOS 10.14+, Linux (支持GTK3)
- **摄像头**: 支持720p或更高分辨率

#### 推荐配置
- **CPU**: Intel i5或更高
- **内存**: 8GB或更高
- **显卡**: 支持硬件加速
- **浏览器内核**: Chromium (Electron内置)

### 3.2 项目初始化

```bash
# 1. 克隆项目（或解压项目包）
cd /path/to/posture-scan-pro

# 2. 安装依赖
npm install

# 3. 配置数据库连接
# 复制.env.example为.env（如果存在），或直接编辑.env文件
```

### 3.3 环境变量配置

在项目根目录创建`.env`文件：

```ini
# 数据库连接配置
DB_HOST=localhost          # 数据库服务器地址
DB_USER=root              # 数据库用户名
DB_PASSWORD=12345678      # 数据库密码
DB_DATABASE=posture_scan_pro_db  # 数据库名称
```

**安全提示**: `.env`文件包含敏感信息，切勿提交到版本控制系统！

### 3.4 启动命令

```bash
# 仅启动React开发服务器（浏览器模式，端口3000）
npm start

# 仅启动Electron窗口（需先启动React服务）
npm run electron

# 同时启动React和Electron（推荐开发模式）
npm run electron:start

# 构建生产版本
npm run build
```

---

## 4. 数据库设计

### 4.1 数据库架构

**数据库名称**: `posture_scan_pro_db`

### 4.2 数据表设计

#### 4.2.1 patients (人员表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 人员唯一标识 |
| name | VARCHAR(100) | NOT NULL | 姓名 |
| gender | ENUM('男','女','其他') | NOT NULL | 性别 |
| age | INT | NOT NULL | 年龄 |
| height | DECIMAL(5,2) |  | 身高(cm) |
| weight | DECIMAL(5,2) |  | 体重(kg) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_name (name)

**参考SQL**:
```sql
CREATE TABLE patients (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  gender ENUM('男','女','其他') NOT NULL,
  age INT NOT NULL,
  height DECIMAL(5,2),
  weight DECIMAL(5,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.2 assessments (评估表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 评估唯一标识 |
| patient_id | INT | FOREIGN KEY, NOT NULL | 关联人员ID |
| assessment_data | JSON | NOT NULL | 评估数据(JSON格式) |
| screenshot | LONGTEXT |  | 截图(Base64编码) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 评估时间 |

**索引**:
- PRIMARY KEY (id)
- FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE
- INDEX idx_patient_id (patient_id)

**参考SQL**:
```sql
CREATE TABLE assessments (
  id INT AUTO_INCREMENT PRIMARY KEY,
  patient_id INT NOT NULL,
  assessment_data JSON NOT NULL,
  screenshot LONGTEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE,
  INDEX idx_patient_id (patient_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.3 exercise_categories (运动分类表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 分类ID |
| name | VARCHAR(100) | NOT NULL | 分类名称 |
| description | TEXT |  | 分类描述 |

**参考SQL**:
```sql
CREATE TABLE exercise_categories (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 插入初始数据
INSERT INTO exercise_categories (name, description) VALUES
('下肢训练', '腿部和臀部力量训练'),
('上肢训练', '手臂和肩部力量训练');
```

#### 4.2.4 exercises (运动项目表)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 运动ID |
| category_id | INT | FOREIGN KEY, NOT NULL | 分类ID |
| name | VARCHAR(100) | NOT NULL | 运动名称 |
| slug | VARCHAR(100) | UNIQUE, NOT NULL | URL友好标识 |
| description | TEXT |  | 运动描述 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (slug)
- FOREIGN KEY (category_id) REFERENCES exercise_categories(id)

**参考SQL**:
```sql
CREATE TABLE exercises (
  id INT AUTO_INCREMENT PRIMARY KEY,
  category_id INT NOT NULL,
  name VARCHAR(100) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  FOREIGN KEY (category_id) REFERENCES exercise_categories(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 插入初始数据
INSERT INTO exercises (category_id, name, slug, description) VALUES
(1, '标准深蹲', 'standard-squat', '基础下肢力量训练'),
(2, '二头弯举', 'bicep-curl', '手臂二头肌训练');
```

### 4.3 数据库连接池配置

在`app/main.js`中配置：

```javascript
const dbPool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_DATABASE,
  waitForConnections: true,
  connectionLimit: 10,      // 最大连接数
  queueLimit: 0            // 无限队列
});
```

---

## 5. 项目结构

```
posture-scan-pro/
├── app/                          # Electron主进程
│   ├── main.js                   # 主进程入口、窗口管理、IPC处理
│   └── preload.js                # 预加载脚本、安全API桥接
│
├── public/                       # 静态资源
│   ├── index.html                # HTML模板
│   └── assets/                   # 图片、图标等
│
├── src/                          # React源代码
│   ├── index.js                  # React入口
│   ├── index.css                 # 全局样式
│   ├── App.js                    # 应用根组件、路由配置
│   ├── App.css                   # 应用样式
│   │
│   ├── components/               # 通用UI组件
│   │   ├── Layout.js             # 主布局(导航+内容区)
│   │   ├── Dashboard.js          # 人员管理仪表板
│   │   ├── Welcome.js            # 欢迎页
│   │   ├── Reports.js            # 报告列表
│   │   └── ...
│   │
│   ├── pages/                    # 路由页面
│   │   ├── PatientDetailPage.js       # 人员详情页
│   │   ├── ReportDetailPage.js        # 报告详情页
│   │   ├── ExerciseSelectionPage.js   # 运动选择页
│   │   ├── ExerciseAnalysisPage.js    # 标准深蹲分析页
│   │   ├── BicepCurlAnalysisPage.js   # 二头弯举分析页
│   │   ├── DatasetShowcase.js         # 数据展示页
│   │   └── ...
│   │
│   ├── modules/                  # 功能模块
│   │   ├── patient/              # 人员管理模块
│   │   │   ├── PatientDetail.js
│   │   │   ├── PatientFormModal.js
│   │   │   └── ...
│   │   │
│   │   ├── posture/              # 姿态检测模块
│   │   │   ├── PostureCapture.js       # 静态体态捕获
│   │   │   ├── StandardSquat.js        # 标准深蹲组件
│   │   │   ├── squatUtils.js           # 深蹲工具函数
│   │   │   ├── bicepCurlUtils.js       # 二头弯举工具
│   │   │   ├── components/             # 姿态子组件
│   │   │   │   ├── SquatSetup.js       # 深蹲设置
│   │   │   │   ├── SquattingView.js    # 深蹲视图
│   │   │   │   ├── SessionReport.js    # 训练报告
│   │   │   │   ├── SpinalCurvature.js  # 脊柱曲率
│   │   │   │   ├── DiagramOverlay.js   # 姿势图示叠加
│   │   │   │   ├── AngleGauge.js       # 角度仪表盘
│   │   │   │   ├── MetricsOverlay.js   # 指标叠加
│   │   │   │   ├── metricsDrawer.js    # 指标绘制
│   │   │   │   └── ...
│   │   │   └── ...
│   │   │
│   │   ├── analysis/             # 分析模块
│   │   │   ├── AngleChart.js
│   │   │   ├── PostureView.js
│   │   │   └── ...
│   │   │
│   │   ├── reports/              # 报告模块
│   │   │   ├── ReportList.js
│   │   │   └── ReportViewer.js
│   │   │
│   │   └── ...
│   │
│   ├── contexts/                 # React Context
│   │   └── TrainingSessionContext.js  # 训练会话状态管理
│   │
│   ├── services/                 # 业务逻辑服务
│   │   └── (API调用、数据处理等)
│   │
│   └── utils/                    # 工具函数
│       └── (辅助函数)
│
├── .env                          # 环境变量配置(不提交到Git)
├── .gitignore                    # Git忽略规则
├── package.json                  # 项目配置和依赖
├── package-lock.json             # 依赖锁定文件
└── README.md                     # 项目说明
```

---

## 6. 核心功能模块

### 6.1 人员管理模块

#### 6.1.1 功能概述
- 人员信息增删改查
- 人员列表展示与搜索
- 人员详情查看
- 关联评估历史

#### 6.1.2 核心组件
- **Dashboard.js**: 人员列表主页面
- **PatientFormModal.js**: 人员信息表单弹窗
- **PatientDetailPage.js**: 人员详情页

#### 6.1.3 API接口（IPC）

```javascript
// 获取所有人员
window.api.getPatients() 
// 返回: Promise<Array<Patient>>

// 根据ID获取人员
window.api.getPatientById(id)
// 参数: id (number)
// 返回: Promise<Patient | null>

// 添加人员
window.api.addPatient(patient)
// 参数: patient { name, gender, age, height, weight }
// 返回: Promise<Patient>

// 更新人员信息
window.api.updatePatient(patient)
// 参数: patient { id, name, gender, age, height, weight }
// 返回: Promise<Patient>

// 删除人员
window.api.deletePatient(id)
// 参数: id (number)
// 返回: Promise<number>
```

### 6.2 体态捕获与分析模块

#### 6.2.1 功能概述
- 实时摄像头捕获
- MediaPipe人体关键点检测
- 多角度姿态分析(矢状面、冠状面、横断面)
- 角度计算与偏差评估
- 平衡指数计算

#### 6.2.2 核心组件
- **PostureCapture.js**: 主捕获组件
- **AnalysisPanel.js**: 分析面板
- **AngleChart.js**: 角度图表
- **PostureView.js**: 姿态视图

#### 6.2.3 MediaPipe初始化流程

```javascript
// 1. 创建Pose实例
const pose = new mpPose.Pose({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

// 2. 配置参数
pose.setOptions({
  modelComplexity: 1,              // 模型复杂度 (0/1/2)
  smoothLandmarks: true,           // 平滑关键点
  enableSegmentation: false,       // 是否启用分割
  minDetectionConfidence: 0.5,     // 最小检测置信度
  minTrackingConfidence: 0.5       // 最小追踪置信度
});

// 3. 设置结果回调
pose.onResults((results) => {
  if (results.poseLandmarks) {
    // 处理33个关键点数据
    const landmarks = results.poseLandmarks;
    // 每个关键点包含: {x, y, z, visibility}
  }
});

// 4. 启动摄像头
const camera = new Camera(videoElement, {
  onFrame: async () => {
    await pose.send({ image: videoElement });
  },
  width: 1280,
  height: 720
});
camera.start();
```

#### 6.2.4 关键点索引（MediaPipe Pose Landmarks）

| 索引 | 名称 | 说明 |
|------|------|------|
| 0 | NOSE | 鼻子 |
| 11 | LEFT_SHOULDER | 左肩 |
| 12 | RIGHT_SHOULDER | 右肩 |
| 13 | LEFT_ELBOW | 左肘 |
| 14 | RIGHT_ELBOW | 右肘 |
| 15 | LEFT_WRIST | 左腕 |
| 16 | RIGHT_WRIST | 右腕 |
| 23 | LEFT_HIP | 左髋 |
| 24 | RIGHT_HIP | 右髋 |
| 25 | LEFT_KNEE | 左膝 |
| 26 | RIGHT_KNEE | 右膝 |
| 27 | LEFT_ANKLE | 左踝 |
| 28 | RIGHT_ANKLE | 右踝 |

完整33个关键点请参考[MediaPipe官方文档](https://google.github.io/mediapipe/solutions/pose.html)

### 6.3 运动纠正模块

#### 6.3.1 功能概述
- 深蹲动作实时监测与纠正
- 二头弯举动作监测
- 自动计数
- 动作质量评分
- 实时反馈提示

#### 6.3.2 深蹲训练状态机

```
CONFIG (配置)
  ↓ 用户设定目标次数并开始
INITIALIZING (初始化)
  ↓ 检测到稳定姿态
IDLE (准备)
  ↓ 膝盖角度 < 160°
SQUATTING (下蹲中)
  ↓ 膝盖角度 > 165°
ANALYZING (分析)
  ↓ 完成分析
IDLE (继续) / COMPLETE (结束)
```

#### 6.3.3 核心算法

**角度计算**:
```javascript
function calculateAngle(a, b, c) {
  // a, b, c 为三个关键点的 {x, y} 坐标
  // b 为顶点
  const radians = Math.atan2(c.y - b.y, c.x - b.x) - 
                  Math.atan2(a.y - b.y, a.x - b.x);
  let angle = Math.abs(radians * 180.0 / Math.PI);
  if (angle > 180.0) angle = 360 - angle;
  return angle;
}
```

**深蹲质量评估**:
```javascript
function analyzeSquatPerformance(frames) {
  const minKneeAngle = Math.min(...frames.map(f => f.avgKneeAngle));
  const avgTrunkAngle = frames.reduce((sum, f) => sum + f.trunkAngle, 0) / frames.length;
  
  let quality = 'GOOD';
  let feedback = [];
  
  // 深度评估
  if (minKneeAngle > 100) {
    quality = 'SHALLOW';
    feedback.push('下蹲深度不足，尝试蹲得更低');
  }
  
  // 躯干角度评估
  if (avgTrunkAngle < 60 || avgTrunkAngle > 100) {
    quality = 'POOR';
    feedback.push('躯干角度不正确，保持背部挺直');
  }
  
  return { quality, feedback, minKneeAngle, avgTrunkAngle };
}
```

#### 6.3.4 训练会话保护机制

为防止用户训练中途切换页面导致数据丢失，系统实现了以下保护机制：

**TrainingSessionContext.js**:
```javascript
export const TrainingSessionProvider = ({ children }) => {
  const [isTrainingActive, setIsTrainingActive] = useState(false);
  const [exerciseType, setExerciseType] = useState(null); // 'squat', 'bicep-curl'
  
  const startTraining = useCallback((type) => {
    setIsTrainingActive(true);
    setExerciseType(type);
  }, []);
  
  const endTraining = useCallback(() => {
    setIsTrainingActive(false);
    setExerciseType(null);
  }, []);
  
  return (
    <TrainingSessionContext.Provider value={{ isTrainingActive, exerciseType, startTraining, endTraining }}>
      {children}
    </TrainingSessionContext.Provider>
  );
};
```

**导航拦截（Layout.js）**:
```javascript
const { isTrainingActive, exerciseType } = useTrainingSession();
const [showWarningModal, setShowWarningModal] = useState(false);

const handleNavigation = (item) => {
  if (isTrainingActive && item.path !== location.pathname) {
    // 显示警告弹窗，阻止导航
    setShowWarningModal(true);
    return;
  }
  navigate(item.path);
};
```

**结束按钮功能**:
- 每个训练页面都有"结束训练"按钮
- 点击后清理当前训练数据，生成训练报告
- 自动调用`endTraining()`结束训练会话

### 6.4 报告生成与管理模块

#### 6.4.1 功能概述
- 评估报告自动生成
- 报告历史记录
- 报告详情查看
- 截图保存（Base64格式）

#### 6.4.2 核心组件
- **Reports.js**: 报告列表页
- **ReportDetailPage.js**: 报告详情页
- **SessionReport.js**: 训练报告组件

#### 6.4.3 报告数据结构

**评估数据(assessment_data字段JSON格式)**:
```javascript
{
  sagittalAngles: {
    head: { value: 5.2, status: 'normal' },
    neck: { value: 2.1, status: 'normal' },
    trunk: { value: -3.5, status: 'warning' },
    pelvis: { value: 1.0, status: 'normal' }
  },
  coronalAngles: {
    head: { value: 0.8, status: 'normal' },
    shoulders: { value: 2.3, status: 'warning' },
    pelvis: null,
    knees: null
  },
  balanceIndex: {
    overall: { value: 85, status: 'good' },
    sagittal: { value: 90, status: 'good' },
    coronal: { value: 80, status: 'warning' }
  },
  captureTimestamp: '2025-12-07T10:30:00.000Z'
}
```

#### 6.4.4 API接口（IPC）

```javascript
// 添加评估报告
window.api.addAssessment({ patientId, assessmentData, screenshot })
// 参数: 
//   - patientId: number
//   - assessmentData: object (JSON数据)
//   - screenshot: string (Base64编码图片)
// 返回: Promise<{ id: number }>

// 获取所有评估报告
window.api.getAllAssessments()
// 返回: Promise<Array<Assessment>>

// 根据ID获取评估报告
window.api.getAssessmentById(id)
// 返回: Promise<Assessment | null>

// 根据人员ID获取评估报告列表
window.api.getAssessmentsByPatientId(patientId)
// 返回: Promise<Array<Assessment>>
```

### 6.5 脊柱曲率分析模块

#### 6.5.1 功能概述
- 侧面脊柱曲线检测
- 曲率角度计算
- 健康状态评估

#### 6.5.2 核心组件
- **SpinalCurvature.js**: 脊柱分析主组件

#### 6.5.3 曲率计算原理

```javascript
// 1. 获取肩部和髋部中点
const shoulderMidpoint = {
  x: (leftShoulder.x + rightShoulder.x) / 2,
  y: (leftShoulder.y + rightShoulder.y) / 2
};
const hipMidpoint = {
  x: (leftHip.x + rightHip.x) / 2,
  y: (leftHip.y + rightHip.y) / 2
};

// 2. 计算脊柱实际线与垂直参考线的水平偏移
const horizontalOffset = Math.abs(shoulderMidpoint.x - hipMidpoint.x);

// 3. 计算曲率角度
const spineLength = Math.sqrt(
  Math.pow(shoulderMidpoint.x - hipMidpoint.x, 2) + 
  Math.pow(shoulderMidpoint.y - hipMidpoint.y, 2)
);
const curvatureAngle = Math.atan(horizontalOffset / spineLength) * (180 / Math.PI);

// 4. 健康评估
let assessment = '';
if (curvatureAngle < 2) {
  assessment = '脊柱曲率正常';
} else if (curvatureAngle < 5) {
  assessment = '轻度侧弯，建议关注';
} else {
  assessment = '明显侧弯，建议就医';
}
```

---

## 7. 开发规范

### 7.1 代码规范

#### 7.1.1 文件命名
- **组件文件**: 使用PascalCase命名，如`PatientDetail.js`
- **工具文件**: 使用camelCase命名，如`squatUtils.js`
- **样式文件**: 与组件同名，如`PatientDetail.css`

#### 7.1.2 组件规范
```javascript
// 1. 导入顺序: React → 第三方库 → 本地组件 → 样式
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import CustomComponent from './CustomComponent';
import './Component.css';

// 2. 函数组件使用箭头函数
const MyComponent = ({ prop1, prop2 }) => {
  // 3. Hooks顺序: useState → useEffect → useRef → useCallback → useMemo
  const [state, setState] = useState(initialValue);
  
  useEffect(() => {
    // 副作用逻辑
    return () => {
      // 清理逻辑
    };
  }, [dependencies]);
  
  // 4. 事件处理函数以handle开头
  const handleClick = () => {
    // 处理逻辑
  };
  
  // 5. JSX渲染
  return (
    <div className="my-component">
      {/* 内容 */}
    </div>
  );
};

export default MyComponent;
```

#### 7.1.3 CSS规范
- 使用BEM命名法: `.block__element--modifier`
- 使用CSS变量管理主题色:
```css
:root {
  --primary-color: #0AC461;
  --bg-dark: #121212;
  --text-color: #E0E0E0;
}
```

### 7.2 Git提交规范

```bash
# 格式: <type>(<scope>): <subject>

# 类型(type):
# - feat: 新功能
# - fix: 修复bug
# - docs: 文档更新
# - style: 代码格式调整
# - refactor: 重构
# - test: 测试相关
# - chore: 构建/工具链更新

# 示例:
git commit -m "feat(squat): 添加深蹲结束按钮功能"
git commit -m "fix(camera): 修复摄像头空引用错误"
git commit -m "docs(readme): 更新安装说明"
```

### 7.3 测试规范

#### 7.3.1 单元测试
- 使用Jest + React Testing Library
- 测试文件命名: `Component.test.js`
- 关键业务逻辑必须覆盖

#### 7.3.2 集成测试
- 测试完整用户流程
- 数据库操作测试使用测试数据库

### 7.4 性能优化

#### 7.4.1 React优化
```javascript
// 1. 使用useMemo缓存计算结果
const expensiveValue = useMemo(() => computeExpensiveValue(a, b), [a, b]);

// 2. 使用useCallback缓存函数
const handleClick = useCallback(() => {
  doSomething(a, b);
}, [a, b]);

// 3. 使用React.memo避免无意义的重渲染
const MyComponent = React.memo(({ data }) => {
  return <div>{data}</div>;
});
```

#### 7.4.2 MediaPipe优化
- 降低模型复杂度（0/1/2），根据性能需求选择
- 减少检测频率：不需要60fps，30fps足够
- 限制Canvas绘制范围

#### 7.4.3 数据库优化
- 使用连接池复用连接
- 合理建立索引
- 避免N+1查询

---

## 8. 部署说明

### 8.1 开发环境部署

```bash
# 1. 安装依赖
npm install

# 2. 配置.env文件
# 参考3.3节

# 3. 创建数据库
mysql -u root -p < database.sql

# 4. 启动应用
npm run electron:start
```

### 8.2 生产环境打包

```bash
# 1. 构建React应用
npm run build

# 2. 使用electron-builder打包
# 需先安装: npm install --save-dev electron-builder

# 在package.json中添加:
{
  "build": {
    "appId": "com.posture.scanpro",
    "productName": "PostureScan Pro",
    "files": [
      "build/**/*",
      "app/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "directories": {
      "buildResources": "assets"
    },
    "mac": {
      "target": "dmg",
      "icon": "assets/icon.icns"
    },
    "win": {
      "target": "nsis",
      "icon": "assets/icon.ico"
    },
    "linux": {
      "target": "AppImage",
      "icon": "assets/icon.png"
    }
  }
}

# 3. 执行打包
npx electron-builder --mac   # macOS
npx electron-builder --win   # Windows
npx electron-builder --linux # Linux
```

### 8.3 数据库迁移

#### 8.3.1 导出数据
```bash
# 导出结构和数据
mysqldump -u root -p posture_scan_pro_db > backup.sql

# 仅导出结构
mysqldump -u root -p --no-data posture_scan_pro_db > structure.sql
```

#### 8.3.2 导入数据
```bash
mysql -u root -p posture_scan_pro_db < backup.sql
```

---

## 9. 常见问题

### 9.1 摄像头访问失败

**问题**: 提示"无法访问摄像头"

**解决方案**:
1. 检查系统摄像头权限设置
2. 确保没有其他应用占用摄像头
3. 在Electron中，确保使用HTTPS或localhost
4. 检查浏览器/Electron权限弹窗

### 9.2 数据库连接失败

**问题**: 启动时报错"Database pool is not available"

**解决方案**:
1. 检查MySQL服务是否运行: `mysql.server status` (macOS) 或 `systemctl status mysql` (Linux)
2. 验证`.env`配置是否正确
3. 确认数据库`posture_scan_pro_db`已创建
4. 测试连接: `mysql -u root -p -h localhost`

### 9.3 MediaPipe加载失败

**问题**: 姿态检测不工作，控制台报404错误

**解决方案**:
1. 检查网络连接（需从CDN加载模型）
2. 使用本地模型文件（下载后放入public目录）
```javascript
// 修改locateFile路径
locateFile: (file) => `/mediapipe/pose/${file}`
```
3. 清除浏览器缓存

### 9.4 训练中途切换页面报错

**问题**: "Cannot read properties of null (reading 'video')"

**解决方案**:
- 已修复：在摄像头回调中添加空值检查
- 使用TrainingSessionContext防止用户训练中切换页面
- 确保组件卸载时清理摄像头资源

```javascript
useEffect(() => {
  return () => {
    if (cameraRef.current) {
      cameraRef.current.stop();
      cameraRef.current = null;
    }
    if (webcamRef.current?.video) {
      webcamRef.current.video.srcObject = null;
    }
  };
}, []);
```

### 9.5 Electron窗口白屏

**问题**: 启动后只显示白屏

**解决方案**:
1. 打开开发者工具查看错误: `win.webContents.openDevTools()`
2. 检查React服务是否正常运行: `http://localhost:3000`
3. 确认`ELECTRON_START_URL`环境变量正确
4. 检查build目录是否存在（生产模式）

### 9.6 打包后无法连接数据库

**问题**: 打包后的应用无法读取.env

**解决方案**:
1. 确保`.env`文件包含在打包资源中
2. 或使用electron-store保存配置
3. 提供图形界面配置数据库连接

---

## 10. 维护与更新

### 10.1 依赖更新

```bash
# 查看过时的依赖
npm outdated

# 更新所有依赖到最新版本（谨慎）
npm update

# 更新指定依赖
npm update react react-dom

# 检查安全漏洞
npm audit

# 自动修复漏洞
npm audit fix
```

### 10.2 版本管理

采用语义化版本控制（Semantic Versioning）:
- **主版本号(MAJOR)**: 不兼容的API修改
- **次版本号(MINOR)**: 向下兼容的功能新增
- **修订号(PATCH)**: 向下兼容的bug修复

示例: `1.2.3` → `MAJOR.MINOR.PATCH`

### 10.3 日志与监控

#### 10.3.1 日志系统
建议集成日志库（如winston）:
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

#### 10.3.2 错误追踪
- 捕获未处理的异常
- 记录用户操作路径
- 集成Sentry等错误监控服务

### 10.4 备份策略

1. **数据库定期备份**:
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
mysqldump -u root -p posture_scan_pro_db > backup_$DATE.sql
```

2. **代码版本控制**:
   - 使用Git管理代码
   - 重要版本打tag
   - 使用GitHub/GitLab托管

3. **用户数据导出**:
   - 提供数据导出功能
   - 支持CSV/JSON格式

### 10.5 性能监控

```javascript
// 监控组件渲染性能
const MeasuredComponent = () => {
  useEffect(() => {
    const startTime = performance.now();
    return () => {
      const endTime = performance.now();
      console.log(`Component render time: ${endTime - startTime}ms`);
    };
  });
};
```

---

## 附录

### A. MediaPipe Pose完整关键点列表

| 索引 | 名称 | 说明 |
|------|------|------|
| 0 | NOSE | 鼻子 |
| 1 | LEFT_EYE_INNER | 左眼内角 |
| 2 | LEFT_EYE | 左眼 |
| 3 | LEFT_EYE_OUTER | 左眼外角 |
| 4 | RIGHT_EYE_INNER | 右眼内角 |
| 5 | RIGHT_EYE | 右眼 |
| 6 | RIGHT_EYE_OUTER | 右眼外角 |
| 7 | LEFT_EAR | 左耳 |
| 8 | RIGHT_EAR | 右耳 |
| 9 | MOUTH_LEFT | 嘴左角 |
| 10 | MOUTH_RIGHT | 嘴右角 |
| 11 | LEFT_SHOULDER | 左肩 |
| 12 | RIGHT_SHOULDER | 右肩 |
| 13 | LEFT_ELBOW | 左肘 |
| 14 | RIGHT_ELBOW | 右肘 |
| 15 | LEFT_WRIST | 左腕 |
| 16 | RIGHT_WRIST | 右腕 |
| 17 | LEFT_PINKY | 左小指 |
| 18 | RIGHT_PINKY | 右小指 |
| 19 | LEFT_INDEX | 左食指 |
| 20 | RIGHT_INDEX | 右食指 |
| 21 | LEFT_THUMB | 左拇指 |
| 22 | RIGHT_THUMB | 右拇指 |
| 23 | LEFT_HIP | 左髋 |
| 24 | RIGHT_HIP | 右髋 |
| 25 | LEFT_KNEE | 左膝 |
| 26 | RIGHT_KNEE | 右膝 |
| 27 | LEFT_ANKLE | 左踝 |
| 28 | RIGHT_ANKLE | 右踝 |
| 29 | LEFT_HEEL | 左脚后跟 |
| 30 | RIGHT_HEEL | 右脚后跟 |
| 31 | LEFT_FOOT_INDEX | 左脚趾 |
| 32 | RIGHT_FOOT_INDEX | 右脚趾 |

### B. 快捷键列表

| 功能 | 快捷键 |
|------|--------|
| 打开开发者工具 | Cmd/Ctrl + Shift + I |
| 刷新页面 | Cmd/Ctrl + R |
| 强制刷新 | Cmd/Ctrl + Shift + R |

### C. 参考资源

- **React官方文档**: https://react.dev/
- **Electron官方文档**: https://www.electronjs.org/docs
- **MediaPipe Pose**: https://google.github.io/mediapipe/solutions/pose.html
- **MySQL文档**: https://dev.mysql.com/doc/
- **Chart.js文档**: https://www.chartjs.org/docs/

---

## 文档变更记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-12-07 | 初始版本创建 | 开发团队 |

---

**版权所有 © 2025 PostureScan Pro 开发团队**

本文档仅供内部开发使用，未经授权不得传播。
