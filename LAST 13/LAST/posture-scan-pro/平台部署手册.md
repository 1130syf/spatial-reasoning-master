# PostureScan Pro 平台部署手册

## 文档信息
- **文档版本**: v1.0.0
- **发布日期**: 2025-12-07
- **文档类型**: 部署运维手册
- **适用对象**: 系统管理员、运维人员、IT技术人员

---

## 目录

1. [部署前准备](#1-部署前准备)
2. [环境配置](#2-环境配置)
3. [数据库部署](#3-数据库部署)
4. [应用程序部署](#4-应用程序部署)
5. [生产环境打包](#5-生产环境打包)
6. [系统配置与优化](#6-系统配置与优化)
7. [备份与恢复](#7-备份与恢复)
8. [监控与维护](#8-监控与维护)
9. [故障排查](#9-故障排查)
10. [安全加固](#10-安全加固)

---

## 1. 部署前准备

### 1.1 系统要求

#### 1.1.1 硬件要求

**最低配置**
| 组件 | 要求 | 说明 |
|------|------|------|
| CPU | Intel i3 或同等性能 | 双核2.0GHz以上 |
| 内存 | 4GB RAM | 建议8GB以上 |
| 硬盘 | 20GB可用空间 | SSD优先 |
| 显卡 | 集成显卡 | 支持硬件加速 |
| 摄像头 | 720p | USB摄像头或内置摄像头 |
| 网络 | 100Mbps | 首次安装需联网 |

**推荐配置**
| 组件 | 要求 | 说明 |
|------|------|------|
| CPU | Intel i5/i7 或同等性能 | 四核2.5GHz以上 |
| 内存 | 8GB RAM | 16GB更佳 |
| 硬盘 | 50GB可用空间 | NVMe SSD |
| 显卡 | 独立显卡 | 提升性能 |
| 摄像头 | 1080p | 高清摄像头 |
| 网络 | 1Gbps | 局域网环境 |

#### 1.1.2 操作系统要求

**支持的操作系统**
```
Windows
├── Windows 10 (64位)
│   ├── 专业版 (推荐)
│   ├── 企业版
│   └── 家庭版 (最低1903版本)
└── Windows 11 (64位)
    └── 所有版本

macOS
├── macOS 10.14 Mojave
├── macOS 10.15 Catalina
├── macOS 11 Big Sur
├── macOS 12 Monterey
├── macOS 13 Ventura
└── macOS 14 Sonoma

Linux
├── Ubuntu 20.04 LTS
├── Ubuntu 22.04 LTS
├── CentOS 7/8
├── Debian 10/11
└── Fedora 35+
```

### 1.2 软件依赖清单

#### 1.2.1 必需软件

| 软件 | 版本要求 | 用途 | 下载地址 |
|------|----------|------|----------|
| **Node.js** | v16.0+ | JavaScript运行环境 | https://nodejs.org/ |
| **npm** | v8.0+ | 包管理器 | 随Node.js安装 |
| **MySQL** | v8.0+ | 数据库服务器 | https://dev.mysql.com/downloads/ |
| **Git** | v2.20+ | 版本控制（可选） | https://git-scm.com/ |

#### 1.2.2 可选软件

| 软件 | 用途 | 下载地址 |
|------|------|----------|
| **MySQL Workbench** | 数据库管理工具 | https://www.mysql.com/products/workbench/ |
| **VS Code** | 代码编辑器 | https://code.visualstudio.com/ |
| **Postman** | API测试工具 | https://www.postman.com/ |

### 1.3 部署检查清单

**部署前检查**
```
□ 确认操作系统版本符合要求
□ 确认硬件配置满足最低要求
□ 确认已安装Node.js和npm
□ 确认已安装MySQL数据库
□ 确认防火墙配置允许必要端口
□ 确认摄像头设备正常工作
□ 确认有足够的磁盘空间
□ 确认网络连接正常
□ 准备好数据库账号密码
□ 备份现有数据（升级部署时）
```

---

## 2. 环境配置

### 2.1 Node.js 安装与配置

#### 2.1.1 Windows 安装

**下载安装**
```bash
# 1. 访问 https://nodejs.org/
# 2. 下载 LTS 版本（推荐 v18.x 或 v20.x）
# 3. 运行安装程序，选择默认选项
# 4. 勾选 "Automatically install the necessary tools"
```

**验证安装**
```bash
# 打开命令提示符(CMD)或PowerShell
node --version
# 输出: v18.17.0 (示例)

npm --version
# 输出: 9.8.1 (示例)
```

**配置npm镜像（可选，提升下载速度）**
```bash
# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com

# 验证配置
npm config get registry
```

#### 2.1.2 macOS 安装

**使用官方安装包**
```bash
# 1. 访问 https://nodejs.org/
# 2. 下载 macOS Installer (.pkg)
# 3. 运行安装包，按提示安装
```

**使用Homebrew安装（推荐）**
```bash
# 安装Homebrew（如未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装Node.js
brew install node

# 验证安装
node --version
npm --version
```

#### 2.1.3 Linux 安装

**Ubuntu/Debian**
```bash
# 更新包列表
sudo apt update

# 安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

**CentOS/RHEL**
```bash
# 安装Node.js 18.x
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

### 2.2 MySQL 安装与配置

#### 2.2.1 Windows 安装

**下载安装**
```
1. 访问 https://dev.mysql.com/downloads/installer/
2. 下载 MySQL Installer for Windows
3. 运行安装程序
4. 选择 "Developer Default" 或 "Server only"
5. 设置root密码（请记住此密码）
6. 完成安装
```

**配置MySQL服务**
```bash
# 启动MySQL服务
net start MySQL80

# 停止MySQL服务
net stop MySQL80

# 设置开机自启
# 在"服务"管理器中找到MySQL80，设置为"自动"
```

**登录测试**
```bash
# 打开命令提示符
mysql -u root -p
# 输入密码后应能成功登录
```

#### 2.2.2 macOS 安装

**使用DMG安装包**
```
1. 访问 https://dev.mysql.com/downloads/mysql/
2. 下载 macOS DMG Archive
3. 运行安装包
4. 记下自动生成的临时密码
5. 完成安装
```

**使用Homebrew安装（推荐）**
```bash
# 安装MySQL
brew install mysql

# 启动MySQL服务
brew services start mysql

# 安全设置（设置root密码）
mysql_secure_installation

# 登录测试
mysql -u root -p
```

#### 2.2.3 Linux 安装

**Ubuntu/Debian**
```bash
# 更新包列表
sudo apt update

# 安装MySQL Server
sudo apt install mysql-server

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全设置
sudo mysql_secure_installation

# 登录测试
sudo mysql -u root -p
```

**CentOS/RHEL**
```bash
# 下载MySQL Yum仓库
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm

# 安装仓库
sudo rpm -ivh mysql80-community-release-el7-3.noarch.rpm

# 安装MySQL Server
sudo yum install mysql-server

# 启动服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 获取临时密码
sudo grep 'temporary password' /var/log/mysqld.log

# 登录并修改密码
mysql -u root -p
ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';
```

### 2.3 MySQL 字符集配置

**修改配置文件**

**Windows** (`C:\ProgramData\MySQL\MySQL Server 8.0\my.ini`)
```ini
[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

[client]
default-character-set=utf8mb4

[mysql]
default-character-set=utf8mb4
```

**macOS/Linux** (`/etc/my.cnf` 或 `/etc/mysql/my.cnf`)
```ini
[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
max_connections=500

[client]
default-character-set=utf8mb4

[mysql]
default-character-set=utf8mb4
```

**重启MySQL服务**
```bash
# Windows
net stop MySQL80
net start MySQL80

# macOS
brew services restart mysql

# Linux
sudo systemctl restart mysql
```

---

## 3. 数据库部署

### 3.1 创建数据库

**登录MySQL**
```bash
mysql -u root -p
# 输入密码
```

**创建数据库**
```sql
-- 创建数据库
CREATE DATABASE posture_scan_pro_db 
  DEFAULT CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

-- 查看数据库
SHOW DATABASES;

-- 使用数据库
USE posture_scan_pro_db;
```

### 3.2 创建数据表

#### 3.2.1 创建人员表

```sql
-- 人员信息表
CREATE TABLE patients (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '人员ID',
  name VARCHAR(100) NOT NULL COMMENT '姓名',
  gender ENUM('男','女','其他') NOT NULL COMMENT '性别',
  age INT NOT NULL COMMENT '年龄',
  height DECIMAL(5,2) COMMENT '身高(cm)',
  weight DECIMAL(5,2) COMMENT '体重(kg)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_name (name),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='人员信息表';

-- 验证表结构
DESC patients;
```

#### 3.2.2 创建评估表

```sql
-- 评估报告表
CREATE TABLE assessments (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '评估ID',
  patient_id INT NOT NULL COMMENT '关联人员ID',
  assessment_data JSON NOT NULL COMMENT '评估数据(JSON格式)',
  screenshot LONGTEXT COMMENT '截图(Base64编码)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '评估时间',
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE,
  INDEX idx_patient_id (patient_id),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评估报告表';

-- 验证表结构
DESC assessments;
```

#### 3.2.3 创建运动分类表

```sql
-- 运动分类表
CREATE TABLE exercise_categories (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '分类ID',
  name VARCHAR(100) NOT NULL COMMENT '分类名称',
  description TEXT COMMENT '分类描述',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='运动分类表';

-- 插入初始数据
INSERT INTO exercise_categories (name, description) VALUES
('下肢训练', '腿部和臀部力量训练'),
('上肢训练', '手臂和肩部力量训练'),
('核心训练', '腹部和背部核心肌群训练');

-- 验证数据
SELECT * FROM exercise_categories;
```

#### 3.2.4 创建运动项目表

```sql
-- 运动项目表
CREATE TABLE exercises (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '运动ID',
  category_id INT NOT NULL COMMENT '分类ID',
  name VARCHAR(100) NOT NULL COMMENT '运动名称',
  slug VARCHAR(100) UNIQUE NOT NULL COMMENT 'URL友好标识',
  description TEXT COMMENT '运动描述',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (category_id) REFERENCES exercise_categories(id) ON DELETE CASCADE,
  UNIQUE KEY uk_slug (slug),
  INDEX idx_category_id (category_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='运动项目表';

-- 插入初始数据
INSERT INTO exercises (category_id, name, slug, description) VALUES
(1, '标准深蹲', 'standard-squat', '基础下肢力量训练，锻炼大腿和臀部肌肉'),
(2, '二头弯举', 'bicep-curl', '手臂二头肌训练，增强上肢力量');

-- 验证数据
SELECT e.*, ec.name as category_name 
FROM exercises e 
JOIN exercise_categories ec ON e.category_id = ec.id;
```

### 3.3 创建数据库用户（可选，生产环境推荐）

```sql
-- 创建专用数据库用户（不使用root）
CREATE USER 'posture_user'@'localhost' IDENTIFIED BY 'Strong@Password123';

-- 授予权限
GRANT ALL PRIVILEGES ON posture_scan_pro_db.* TO 'posture_user'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证用户
SELECT User, Host FROM mysql.user WHERE User = 'posture_user';

-- 测试登录
-- 退出当前会话
EXIT;

-- 使用新用户登录
mysql -u posture_user -p
USE posture_scan_pro_db;
SHOW TABLES;
```

### 3.4 数据库备份脚本

**创建备份目录**
```bash
# Windows
mkdir C:\backup\mysql

# macOS/Linux
sudo mkdir -p /backup/mysql
sudo chmod 755 /backup/mysql
```

**备份脚本（Windows - backup.bat）**
```batch
@echo off
set BACKUP_DIR=C:\backup\mysql
set DB_NAME=posture_scan_pro_db
set DB_USER=root
set DATE=%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%
set DATE=%DATE: =0%

echo 开始备份数据库...
mysqldump -u %DB_USER% -p %DB_NAME% > %BACKUP_DIR%\%DB_NAME%_%DATE%.sql

echo 备份完成: %BACKUP_DIR%\%DB_NAME%_%DATE%.sql
pause
```

**备份脚本（macOS/Linux - backup.sh）**
```bash
#!/bin/bash

# 配置
BACKUP_DIR="/backup/mysql"
DB_NAME="posture_scan_pro_db"
DB_USER="root"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${DATE}.sql"

# 执行备份
echo "开始备份数据库..."
mysqldump -u ${DB_USER} -p ${DB_NAME} > ${BACKUP_FILE}

# 压缩备份文件
gzip ${BACKUP_FILE}

# 删除7天前的备份
find ${BACKUP_DIR} -name "${DB_NAME}_*.sql.gz" -mtime +7 -delete

echo "备份完成: ${BACKUP_FILE}.gz"
```

**设置执行权限（Linux/macOS）**
```bash
chmod +x backup.sh
```

---

## 4. 应用程序部署

### 4.1 获取项目源码

#### 4.1.1 从压缩包部署

```bash
# 1. 解压项目包到目标目录
# Windows
cd C:\Apps
unzip posture-scan-pro.zip

# macOS/Linux
cd /opt
sudo unzip posture-scan-pro.zip
sudo chown -R $USER:$USER posture-scan-pro
```

#### 4.1.2 从Git仓库部署

```bash
# 克隆仓库
git clone https://github.com/your-org/posture-scan-pro.git
cd posture-scan-pro

# 切换到指定版本（可选）
git checkout v1.0.0
```

### 4.2 安装项目依赖

```bash
# 进入项目目录
cd posture-scan-pro

# 安装依赖（首次部署或更新后）
npm install

# 如果安装速度慢，使用淘宝镜像
npm install --registry=https://registry.npmmirror.com
```

**预期输出**
```
added 1423 packages in 2m
35 packages are looking for funding
  run `npm fund` for details
```

**常见问题处理**
```bash
# 如果遇到权限问题（Linux/macOS）
sudo npm install

# 如果遇到版本冲突
rm -rf node_modules package-lock.json
npm install

# 如果遇到网络问题
npm install --legacy-peer-deps
```

### 4.3 环境变量配置

#### 4.3.1 创建.env文件

**Windows**
```bash
cd posture-scan-pro
copy .env.example .env
notepad .env
```

**macOS/Linux**
```bash
cd posture-scan-pro
cp .env.example .env
nano .env
# 或使用 vim .env
```

#### 4.3.2 配置数据库连接

**编辑.env文件**
```ini
# 数据库连接配置
# 请将下面的占位符替换为您的真实MySQL信息

# 数据库服务器地址
# 本地部署: localhost
# 远程服务器: 填写IP地址或域名
DB_HOST=localhost

# 数据库用户名
# 如果创建了专用用户，使用 posture_user
# 否则使用 root
DB_USER=root

# 数据库密码
# 替换为您在安装MySQL时设置的密码
DB_PASSWORD=YourMySQLPassword

# 数据库名称
# 必须与创建的数据库名称一致
DB_DATABASE=posture_scan_pro_db
```

**配置示例**
```ini
# 示例1: 使用root用户
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=MySecurePass123
DB_DATABASE=posture_scan_pro_db

# 示例2: 使用专用用户
DB_HOST=localhost
DB_USER=posture_user
DB_PASSWORD=Strong@Password123
DB_DATABASE=posture_scan_pro_db

# 示例3: 远程数据库
DB_HOST=192.168.1.100
DB_USER=remote_user
DB_PASSWORD=RemotePass456
DB_DATABASE=posture_scan_pro_db
```

### 4.4 测试数据库连接

**创建测试脚本（test-db.js）**
```javascript
// test-db.js
require('dotenv').config();
const mysql = require('mysql2/promise');

async function testConnection() {
  try {
    console.log('正在连接数据库...');
    console.log(`主机: ${process.env.DB_HOST}`);
    console.log(`用户: ${process.env.DB_USER}`);
    console.log(`数据库: ${process.env.DB_DATABASE}`);
    
    const connection = await mysql.createConnection({
      host: process.env.DB_HOST,
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_DATABASE,
    });
    
    console.log('✓ 数据库连接成功！');
    
    const [rows] = await connection.query('SHOW TABLES');
    console.log(`✓ 找到 ${rows.length} 个数据表:`);
    rows.forEach(row => {
      console.log(`  - ${Object.values(row)[0]}`);
    });
    
    await connection.end();
    process.exit(0);
  } catch (error) {
    console.error('✗ 数据库连接失败:');
    console.error(error.message);
    process.exit(1);
  }
}

testConnection();
```

**运行测试**
```bash
node test-db.js
```

**预期输出**
```
正在连接数据库...
主机: localhost
用户: root
数据库: posture_scan_pro_db
✓ 数据库连接成功！
✓ 找到 4 个数据表:
  - assessments
  - exercise_categories
  - exercises
  - patients
```

### 4.5 启动应用程序

#### 4.5.1 开发模式启动

**同时启动React和Electron（推荐）**
```bash
npm run electron:start
```

**分步启动**
```bash
# 终端1: 启动React开发服务器
npm start

# 终端2: 等待React启动完成后，启动Electron
npm run electron
```

**预期输出**
```
Compiled successfully!

You can now view posture-scan-pro in the browser.

  Local:            http://localhost:3000
  On Your Network:  http://192.168.1.100:3000

Note that the development build is not optimized.
To create a production build, use npm run build.

webpack compiled successfully
```

#### 4.5.2 验证启动成功

**检查项**
```
□ Electron窗口正常打开
□ 界面显示正常（无白屏）
□ 侧边栏菜单可点击
□ 数据库连接正常（人员管理页面能加载）
□ 摄像头权限请求正常弹出
□ 控制台无严重错误
```

**打开开发者工具查看日志**
```
快捷键: Ctrl + Shift + I (Windows/Linux)
       Cmd + Option + I (macOS)
```

---

## 5. 生产环境打包

### 5.1 构建生产版本

**清理旧构建**
```bash
# Windows
rmdir /s /q build

# macOS/Linux
rm -rf build
```

**构建React应用**
```bash
npm run build
```

**预期输出**
```
Creating an optimized production build...
Compiled successfully.

File sizes after gzip:

  89.12 KB  build/static/js/main.abc123.js
  12.34 KB  build/static/css/main.def456.css

The project was built assuming it is hosted at /.
You can control this with the homepage field in your package.json.

The build folder is ready to be deployed.
```

### 5.2 配置Electron Builder

**在package.json中添加build配置**
```json
{
  "name": "posture-scan-pro",
  "version": "1.0.0",
  "description": "3D Posture Assessment System",
  "main": "app/main.js",
  "author": "Your Company",
  "license": "MIT",
  "build": {
    "appId": "com.yourcompany.posturescanpro",
    "productName": "PostureScan Pro",
    "copyright": "Copyright © 2025 ${author}",
    "files": [
      "build/**/*",
      "app/**/*",
      "node_modules/**/*",
      "package.json",
      ".env"
    ],
    "directories": {
      "buildResources": "build",
      "output": "dist"
    },
    "win": {
      "target": [
        "nsis",
        "portable"
      ],
      "icon": "build/icon.ico"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "PostureScan Pro"
    },
    "mac": {
      "target": [
        "dmg",
        "zip"
      ],
      "icon": "build/icon.icns",
      "category": "public.app-category.healthcare-fitness"
    },
    "dmg": {
      "contents": [
        {
          "x": 130,
          "y": 220
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ]
    },
    "linux": {
      "target": [
        "AppImage",
        "deb"
      ],
      "icon": "build/icons",
      "category": "Utility"
    }
  }
}
```

### 5.3 安装Electron Builder

```bash
npm install --save-dev electron-builder
```

### 5.4 执行打包

#### 5.4.1 Windows平台打包

```bash
# 打包为安装程序和便携版
npx electron-builder --win

# 仅打包安装程序
npx electron-builder --win --x64

# 仅打包便携版
npx electron-builder --win --x64 --config.win.target=portable
```

**输出文件**
```
dist/
├── PostureScan Pro Setup 1.0.0.exe      # 安装程序
├── PostureScan Pro 1.0.0.exe            # 便携版
└── latest.yml                            # 更新配置
```

#### 5.4.2 macOS平台打包

```bash
# 打包为DMG和ZIP
npx electron-builder --mac

# 仅打包DMG
npx electron-builder --mac --config.mac.target=dmg
```

**输出文件**
```
dist/
├── PostureScan Pro-1.0.0.dmg            # 安装镜像
├── PostureScan Pro-1.0.0-mac.zip        # ZIP包
└── latest-mac.yml                        # 更新配置
```

#### 5.4.3 Linux平台打包

```bash
# 打包为AppImage和DEB
npx electron-builder --linux

# 仅打包AppImage
npx electron-builder --linux --config.linux.target=AppImage
```

**输出文件**
```
dist/
├── PostureScan Pro-1.0.0.AppImage       # AppImage
├── posture-scan-pro_1.0.0_amd64.deb     # DEB包
└── latest-linux.yml                      # 更新配置
```

### 5.5 打包优化

**减小包体积**
```json
{
  "build": {
    "compression": "maximum",
    "asar": true,
    "asarUnpack": [
      "node_modules/mediapipe/**/*"
    ]
  }
}
```

**配置文件过滤**
```json
{
  "build": {
    "files": [
      "!**/*.map",
      "!**/node_modules/*/{CHANGELOG.md,README.md,README,readme.md,readme}",
      "!**/node_modules/*/{test,__tests__,tests,powered-test,example,examples}",
      "!**/node_modules/*.d.ts",
      "!**/node_modules/.bin",
      "!**/*.{iml,o,hprof,orig,pyc,pyo,rbc,swp,csproj,sln,xproj}",
      "!.editorconfig",
      "!**/._*",
      "!**/{.DS_Store,.git,.hg,.svn,CVS,RCS,SCCS,.gitignore,.gitattributes}",
      "!**/{__pycache__,thumbs.db,.flowconfig,.idea,.vs,.nyc_output}",
      "!**/{appveyor.yml,.travis.yml,circle.yml}",
      "!**/{npm-debug.log,yarn.lock,.yarn-integrity,.yarn-metadata.json}"
    ]
  }
}
```

---

## 6. 系统配置与优化

### 6.1 MySQL性能优化

**编辑MySQL配置文件**

**Windows**: `C:\ProgramData\MySQL\MySQL Server 8.0\my.ini`
**macOS/Linux**: `/etc/my.cnf` 或 `/etc/mysql/my.cnf`

```ini
[mysqld]
# 基础配置
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# 性能优化
max_connections=500
max_allowed_packet=64M

# InnoDB优化
innodb_buffer_pool_size=1G
innodb_log_file_size=256M
innodb_flush_log_at_trx_commit=2
innodb_flush_method=O_DIRECT

# 查询缓存（MySQL 5.7）
# MySQL 8.0已移除查询缓存
query_cache_size=0
query_cache_type=0

# 临时表
tmp_table_size=64M
max_heap_table_size=64M

# 日志
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow-query.log
long_query_time=2

# 二进制日志（可选，用于主从复制或恢复）
log_bin=/var/log/mysql/mysql-bin.log
expire_logs_days=7
max_binlog_size=100M
```

**重启MySQL使配置生效**
```bash
# Windows
net stop MySQL80
net start MySQL80

# macOS
brew services restart mysql

# Linux
sudo systemctl restart mysql
```

### 6.2 应用程序优化

#### 6.2.1 MediaPipe性能优化

**修改PostureCapture.js配置**
```javascript
// 生产环境优化配置
pose.setOptions({
  modelComplexity: 0,  // 使用轻量级模型（0/1/2）
  smoothLandmarks: true,
  enableSegmentation: false,  // 禁用分割以提升性能
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});
```

#### 6.2.2 摄像头分辨率优化

```javascript
// 降低分辨率以提升性能
const camera = new Camera(videoElement, {
  onFrame: async () => {
    await pose.send({ image: videoElement });
  },
  width: 960,   // 从1280降低到960
  height: 540,  // 从720降低到540
});
```

### 6.3 系统防火墙配置

**Windows防火墙**
```bash
# 允许Electron应用通过防火墙
# 1. 打开 Windows Defender 防火墙
# 2. 点击"允许应用通过防火墙"
# 3. 点击"更改设置"
# 4. 找到 PostureScan Pro，勾选"专用"和"公用"
# 5. 点击"确定"
```

**macOS防火墙**
```bash
# 系统偏好设置 → 安全性与隐私 → 防火墙
# 点击"防火墙选项"
# 添加 PostureScan Pro.app
# 选择"允许传入连接"
```

**Linux防火墙（UFW）**
```bash
# 允许MySQL端口（如果数据库在远程服务器）
sudo ufw allow 3306/tcp

# 允许React开发服务器端口（开发环境）
sudo ufw allow 3000/tcp

# 查看状态
sudo ufw status
```

---

## 7. 备份与恢复

### 7.1 数据备份策略

#### 7.1.1 自动备份脚本

**Windows定时任务**
```batch
@echo off
REM backup-auto.bat
set BACKUP_DIR=C:\backup\mysql
set DB_NAME=posture_scan_pro_db
set DB_USER=root
set DB_PASS=YourPassword
set DATE=%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%
set DATE=%DATE: =0%

mysqldump -u %DB_USER% -p%DB_PASS% %DB_NAME% > %BACKUP_DIR%\%DB_NAME%_%DATE%.sql

REM 删除30天前的备份
forfiles /p %BACKUP_DIR% /s /m *.sql /d -30 /c "cmd /c del @path"
```

**设置Windows计划任务**
```
1. 打开"任务计划程序"
2. 创建基本任务
3. 名称: PostureScan Pro Database Backup
4. 触发器: 每天凌晨2:00
5. 操作: 启动程序 → backup-auto.bat
6. 完成创建
```

**Linux Cron任务**
```bash
# 编辑crontab
crontab -e

# 添加以下行（每天凌晨2:00执行备份）
0 2 * * * /opt/posture-scan-pro/scripts/backup.sh >> /var/log/posture-backup.log 2>&1

# 保存并退出
```

#### 7.1.2 备份文件结构

```
/backup/mysql/
├── posture_scan_pro_db_20251207_020000.sql.gz
├── posture_scan_pro_db_20251206_020000.sql.gz
├── posture_scan_pro_db_20251205_020000.sql.gz
└── ...
```

### 7.2 数据恢复

#### 7.2.1 从SQL文件恢复

**完整恢复**
```bash
# 1. 解压备份文件（如果已压缩）
gunzip posture_scan_pro_db_20251207_020000.sql.gz

# 2. 登录MySQL
mysql -u root -p

# 3. 删除现有数据库（谨慎操作！）
DROP DATABASE IF EXISTS posture_scan_pro_db;

# 4. 创建新数据库
CREATE DATABASE posture_scan_pro_db 
  DEFAULT CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

# 5. 退出MySQL
EXIT;

# 6. 导入备份
mysql -u root -p posture_scan_pro_db < posture_scan_pro_db_20251207_020000.sql
```

**单表恢复**
```bash
# 从备份文件中提取单表
sed -n '/CREATE TABLE `patients`/,/UNLOCK TABLES/p' backup.sql > patients_only.sql

# 导入单表
mysql -u root -p posture_scan_pro_db < patients_only.sql
```

#### 7.2.2 应用程序恢复

**从安装包重新安装**
```
1. 卸载现有应用程序
2. 运行安装程序
3. 选择安装目录
4. 完成安装
5. 复制.env配置文件
6. 启动应用验证
```

**从源码重新部署**
```bash
# 1. 清理旧安装
rm -rf node_modules
rm -rf build

# 2. 重新安装依赖
npm install

# 3. 重新构建
npm run build

# 4. 启动应用
npm run electron:start
```

---

## 8. 监控与维护

### 8.1 系统监控

#### 8.1.1 MySQL监控

**查看数据库状态**
```sql
-- 查看连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看慢查询
SHOW STATUS LIKE 'Slow_queries';

-- 查看表大小
SELECT 
  table_name AS `Table`,
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS `Size (MB)`
FROM information_schema.TABLES
WHERE table_schema = 'posture_scan_pro_db'
ORDER BY (data_length + index_length) DESC;

-- 查看InnoDB状态
SHOW ENGINE INNODB STATUS\G
```

**监控脚本（monitor-db.sh）**
```bash
#!/bin/bash

# 数据库监控脚本
DB_USER="root"
DB_NAME="posture_scan_pro_db"
LOG_FILE="/var/log/mysql-monitor.log"

echo "=== MySQL监控报告 $(date) ===" >> $LOG_FILE

# 连接数
echo "当前连接数:" >> $LOG_FILE
mysql -u $DB_USER -p -e "SHOW STATUS LIKE 'Threads_connected';" >> $LOG_FILE

# 数据库大小
echo "数据库大小:" >> $LOG_FILE
mysql -u $DB_USER -p -e "
SELECT 
  ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.TABLES
WHERE table_schema = '$DB_NAME';
" >> $LOG_FILE

echo "=====================================" >> $LOG_FILE
```

#### 8.1.2 应用程序监控

**日志文件位置**
```
Windows:
%APPDATA%\posture-scan-pro\logs\

macOS:
~/Library/Logs/posture-scan-pro/

Linux:
~/.config/posture-scan-pro/logs/
```

**启用详细日志（开发模式）**
```javascript
// app/main.js
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// 使用示例
logger.info('应用程序启动');
logger.error('数据库连接失败', { error: err.message });
```

### 8.2 维护任务清单

**每日维护**
```
□ 检查应用程序运行状态
□ 查看错误日志
□ 验证数据库备份是否成功
□ 监控磁盘空间使用
```

**每周维护**
```
□ 检查数据库表大小和增长趋势
□ 优化数据库（OPTIMIZE TABLE）
□ 清理旧备份文件
□ 更新系统安全补丁
```

**每月维护**
```
□ 数据库完整性检查
□ 性能基准测试
□ 审查用户反馈和错误报告
□ 更新第三方依赖库
```

**数据库优化命令**
```sql
-- 分析表
ANALYZE TABLE patients;
ANALYZE TABLE assessments;

-- 优化表
OPTIMIZE TABLE patients;
OPTIMIZE TABLE assessments;

-- 检查表
CHECK TABLE patients;
CHECK TABLE assessments;

-- 修复表（如有问题）
REPAIR TABLE patients;
```

---

## 9. 故障排查

### 9.1 常见问题及解决方案

#### 9.1.1 数据库连接失败

**问题表现**
```
Error: Database pool is not available
Error: Access denied for user 'root'@'localhost'
```

**排查步骤**
```bash
# 1. 检查MySQL服务状态
# Windows
sc query MySQL80

# macOS
brew services list | grep mysql

# Linux
sudo systemctl status mysql

# 2. 测试MySQL登录
mysql -u root -p

# 3. 检查.env配置
cat .env | grep DB_

# 4. 验证数据库存在
mysql -u root -p -e "SHOW DATABASES LIKE 'posture_scan_pro_db';"
```

**解决方案**
```sql
-- 如果用户权限问题
GRANT ALL PRIVILEGES ON posture_scan_pro_db.* TO 'root'@'localhost';
FLUSH PRIVILEGES;

-- 如果密码错误，重置密码
ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';
```

#### 9.1.2 应用程序无法启动

**问题表现**
```
Application error: a client-side exception has occurred
白屏或黑屏
Electron窗口闪退
```

**排查步骤**
```bash
# 1. 检查Node.js版本
node --version
npm --version

# 2. 检查依赖是否完整
npm list --depth=0

# 3. 查看错误日志
# 打开开发者工具: Ctrl+Shift+I

# 4. 检查端口占用（开发模式）
# Windows
netstat -ano | findstr :3000

# macOS/Linux
lsof -i :3000
```

**解决方案**
```bash
# 清理缓存并重新安装
rm -rf node_modules package-lock.json
npm cache clean --force
npm install

# 重新构建
npm run build

# 检查Electron版本兼容性
npm list electron
```

#### 9.1.3 摄像头无法访问

**问题表现**
```
NotAllowedError: Permission denied
NotFoundError: Requested device not found
```

**排查步骤**
```
1. 检查系统权限设置
   Windows: 设置 → 隐私 → 相机
   macOS: 系统偏好设置 → 安全性与隐私 → 相机
   
2. 检查摄像头是否被其他应用占用
   关闭QQ、微信、Zoom等应用
   
3. 检查摄像头驱动
   设备管理器中查看摄像头状态
   
4. 测试摄像头
   使用系统自带相机应用测试
```

**解决方案**
```bash
# 重置应用权限（macOS）
tccutil reset Camera com.yourcompany.posturescanpro

# 重新安装摄像头驱动（Windows）
# 设备管理器 → 摄像头 → 卸载设备 → 重新扫描硬件
```

#### 9.1.4 MediaPipe加载失败

**问题表现**
```
Failed to fetch
404 Not Found: https://cdn.jsdelivr.net/npm/@mediapipe/pose/...
```

**排查步骤**
```bash
# 1. 检查网络连接
ping cdn.jsdelivr.net

# 2. 检查防火墙设置

# 3. 检查浏览器缓存
```

**解决方案**
```javascript
// 方案1: 使用备用CDN
const pose = new Pose({
  locateFile: (file) => {
    return `https://unpkg.com/@mediapipe/pose@0.5.1675469404/${file}`;
  }
});

// 方案2: 使用本地文件
// 1. 下载MediaPipe模型文件到public/mediapipe/
// 2. 修改locateFile路径
const pose = new Pose({
  locateFile: (file) => {
    return `/mediapipe/pose/${file}`;
  }
});
```

### 9.2 性能问题排查

#### 9.2.1 应用运行缓慢

**检查CPU使用率**
```bash
# Windows
tasklist /FI "IMAGENAME eq PostureScan Pro.exe"

# macOS
ps aux | grep "PostureScan Pro"

# Linux
top -p $(pgrep -f "posture-scan-pro")
```

**优化建议**
```javascript
// 1. 降低MediaPipe模型复杂度
modelComplexity: 0  // 从1改为0

// 2. 降低帧率
const camera = new Camera(video, {
  onFrame: async () => {
    // 跳帧处理
    frameCount++;
    if (frameCount % 2 === 0) {
      await pose.send({ image: video });
    }
  }
});

// 3. 减小Canvas尺寸
canvas.width = 640;
canvas.height = 480;
```

#### 9.2.2 数据库查询慢

**查看慢查询日志**
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;

-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query%';
```

**优化建议**
```sql
-- 添加索引
CREATE INDEX idx_assessment_date ON assessments(created_at);

-- 分析查询计划
EXPLAIN SELECT * FROM assessments WHERE patient_id = 1;

-- 优化JOIN查询
SELECT a.*, p.name 
FROM assessments a
INNER JOIN patients p ON a.patient_id = p.id
WHERE a.created_at > DATE_SUB(NOW(), INTERVAL 30 DAY);
```

---

## 10. 安全加固

### 10.1 数据库安全

#### 10.1.1 用户权限最小化

```sql
-- 创建只读用户（用于报表查询）
CREATE USER 'posture_readonly'@'localhost' IDENTIFIED BY 'ReadOnlyPass123';
GRANT SELECT ON posture_scan_pro_db.* TO 'posture_readonly'@'localhost';

-- 创建备份用户
CREATE USER 'posture_backup'@'localhost' IDENTIFIED BY 'BackupPass123';
GRANT SELECT, LOCK TABLES ON posture_scan_pro_db.* TO 'posture_backup'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;
```

#### 10.1.2 启用SSL连接

**生成SSL证书**
```bash
# 生成CA证书
openssl genrsa 2048 > ca-key.pem
openssl req -new -x509 -nodes -days 3650 -key ca-key.pem -out ca-cert.pem

# 生成服务器证书
openssl req -newkey rsa:2048 -days 3650 -nodes -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 3650 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
```

**配置MySQL**
```ini
[mysqld]
ssl-ca=/path/to/ca-cert.pem
ssl-cert=/path/to/server-cert.pem
ssl-key=/path/to/server-key.pem
```

#### 10.1.3 定期审计

```sql
-- 查看用户权限
SELECT user, host FROM mysql.user;
SHOW GRANTS FOR 'root'@'localhost';

-- 查看最近登录
SELECT * FROM mysql.general_log 
WHERE command_type = 'Connect' 
ORDER BY event_time DESC LIMIT 10;
```

### 10.2 应用程序安全

#### 10.2.1 加密敏感配置

**使用dotenv-vault加密.env**
```bash
# 安装dotenv-vault
npm install --save-dev dotenv-vault

# 初始化
npx dotenv-vault new

# 加密.env文件
npx dotenv-vault encrypt

# 生成.env.vault文件
```

#### 10.2.2 代码签名（生产环境）

**Windows代码签名**
```json
{
  "build": {
    "win": {
      "certificateFile": "path/to/cert.pfx",
      "certificatePassword": "your-password",
      "signingHashAlgorithms": ["sha256"],
      "sign": "./customSign.js"
    }
  }
}
```

**macOS代码签名**
```json
{
  "build": {
    "mac": {
      "identity": "Developer ID Application: Your Name (TEAM_ID)",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist"
    }
  }
}
```

### 10.3 网络安全

#### 10.3.1 防火墙规则

**仅允许本地连接（默认配置）**
```ini
[mysqld]
bind-address=127.0.0.1
```

**允许特定IP访问**
```ini
[mysqld]
bind-address=0.0.0.0

# 然后在MySQL中限制用户
CREATE USER 'remote_user'@'192.168.1.100' IDENTIFIED BY 'password';
GRANT ALL ON posture_scan_pro_db.* TO 'remote_user'@'192.168.1.100';
```

#### 10.3.2 禁用不必要的服务

```sql
-- 禁用远程root登录
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
FLUSH PRIVILEGES;
```

---

## 附录

### A. 端口使用说明

| 端口 | 用途 | 说明 |
|------|------|------|
| 3000 | React开发服务器 | 仅开发模式 |
| 3306 | MySQL数据库 | 默认端口 |

### B. 目录结构说明

```
posture-scan-pro/
├── app/                    # Electron主进程
│   ├── main.js            # 主进程入口
│   └── preload.js         # 预加载脚本
├── build/                 # React构建输出
├── dist/                  # Electron打包输出
├── node_modules/          # 依赖包
├── public/                # 静态资源
├── src/                   # React源码
├── .env                   # 环境变量（不提交）
├── package.json           # 项目配置
└── README.md              # 项目说明
```

### C. 环境变量完整列表

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| DB_HOST | 数据库主机地址 | localhost |
| DB_USER | 数据库用户名 | root |
| DB_PASSWORD | 数据库密码 | MyPassword123 |
| DB_DATABASE | 数据库名称 | posture_scan_pro_db |
| NODE_ENV | 运行环境 | production/development |

### D. 快速命令参考

```bash
# 安装依赖
npm install

# 开发模式启动
npm run electron:start

# 构建生产版本
npm run build

# 打包Windows应用
npx electron-builder --win

# 打包macOS应用
npx electron-builder --mac

# 打包Linux应用
npx electron-builder --linux

# 数据库备份
mysqldump -u root -p posture_scan_pro_db > backup.sql

# 数据库恢复
mysql -u root -p posture_scan_pro_db < backup.sql
```

### E. 联系支持

**技术支持**
- 邮箱: support@posturescan.pro
- 电话: 400-XXX-XXXX
- 工作时间: 周一至周五 9:00-18:00

**紧急联系**
- 24小时热线: 136-XXXX-XXXX
- 企业微信: posturescan-support

---

## 文档版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-12-07 | 初始版本发布 | 运维团队 |

---

**版权所有 © 2025 PostureScan Pro**

本手册为内部运维文档，包含敏感配置信息，请妥善保管，不得外传。
